{"version":3,"file":"undeployAction2.js","sources":["../../src/_internal/cli/actions/deploy/undeployAction.ts"],"sourcesContent":["import {type CliCommandArguments, type CliCommandContext} from '@sanity/cli'\n\nimport {debug as debugIt} from '../../debug'\nimport {deleteUserApplication, getUserApplication} from './helpers'\n\nconst debug = debugIt.extend('undeploy')\n\nexport interface UndeployStudioActionFlags {\n  yes?: boolean\n  y?: boolean\n}\n\nexport default async function undeployStudioAction(\n  args: CliCommandArguments<UndeployStudioActionFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const {apiClient, chalk, output, prompt, cliConfig} = context\n  const flags = args.extOptions\n\n  const client = apiClient({\n    requireUser: true,\n    requireProject: true,\n  }).withConfig({apiVersion: 'v2024-08-01'})\n\n  // Check that the project has a studio hostname\n  let spinner = output.spinner('Checking project info').start()\n\n  const appId = cliConfig?.deployment?.appId || undefined\n  const appHost = cliConfig?.studioHost || undefined\n  const userApplication = await getUserApplication({\n    client,\n    ...(appId ? {appId} : {appHost}),\n  })\n\n  spinner.succeed()\n\n  if (!userApplication) {\n    output.print('Your project has not been assigned a studio hostname')\n    output.print('or the `studioHost` provided does not exist.')\n    output.print('Nothing to undeploy.')\n    return\n  }\n\n  // Double-check\n  output.print('')\n\n  const isExternal = userApplication.urlType === 'external'\n  const url = isExternal\n    ? chalk.yellow(userApplication.appHost)\n    : `https://${chalk.yellow(userApplication.appHost)}.sanity.studio`\n\n  /**\n   * Unattended mode means that if there are any prompts it will use `YES` for them but will no change anything that doesn't have a prompt\n   */\n  const unattendedMode = Boolean(flags.yes || flags.y)\n\n  // If it is in unattended mode, we don't want to prompt\n  if (!unattendedMode) {\n    const confirmMessage = isExternal\n      ? `This will unregister the external studio at ${url}.\n  Are you ${chalk.red('sure')} you want to unregister?`\n      : `This will undeploy ${url} and make it unavailable for your users.\n  The hostname will be available for anyone to claim.\n  Are you ${chalk.red('sure')} you want to undeploy?`\n\n    const shouldUndeploy = await prompt.single({\n      type: 'confirm',\n      default: false,\n      message: confirmMessage.trim(),\n    })\n\n    if (!shouldUndeploy) {\n      return\n    }\n  }\n\n  spinner = output.spinner(isExternal ? 'Unregistering studio' : 'Undeploying studio').start()\n  try {\n    await deleteUserApplication({\n      client,\n      applicationId: userApplication.id,\n      appType: 'studio',\n    })\n    spinner.succeed()\n  } catch (err) {\n    spinner.fail()\n    debug('Error undeploying studio', err)\n    throw err\n  }\n\n  output.print(\n    isExternal\n      ? `External studio unregistered.`\n      : `Studio undeploy scheduled. It might take a few minutes before ${url} is unavailable.`,\n  )\n}\n"],"names":["debug","debugIt","extend","undeployStudioAction","args","context","apiClient","chalk","output","prompt","cliConfig","flags","extOptions","client","requireUser","requireProject","withConfig","apiVersion","spinner","start","appId","deployment","undefined","appHost","studioHost","userApplication","getUserApplication","succeed","print","isExternal","urlType","url","yellow","yes","y","confirmMessage","red","single","type","default","message","trim","deleteUserApplication","applicationId","id","appType","err","fail"],"mappings":";;AAKA,MAAMA,QAAQC,QAAQC,OAAO,UAAU;AAOvC,eAA8BC,qBAC5BC,MACAC,SACe;AACf,QAAM;AAAA,IAACC;AAAAA,IAAWC;AAAAA,IAAOC;AAAAA,IAAQC;AAAAA,IAAQC;AAAAA,EAAAA,IAAaL,SAChDM,QAAQP,KAAKQ,YAEbC,SAASP,UAAU;AAAA,IACvBQ,aAAa;AAAA,IACbC,gBAAgB;AAAA,EAAA,CACjB,EAAEC,WAAW;AAAA,IAACC,YAAY;AAAA,EAAA,CAAc;AAGzC,MAAIC,UAAUV,OAAOU,QAAQ,uBAAuB,EAAEC,MAAAA;AAEtD,QAAMC,QAAQV,WAAWW,YAAYD,SAASE,QACxCC,UAAUb,WAAWc,cAAcF,QACnCG,kBAAkB,MAAMC,mBAAmB;AAAA,IAC/Cb;AAAAA,IACA,GAAIO,QAAQ;AAAA,MAACA;AAAAA,IAAAA,IAAS;AAAA,MAACG;AAAAA,IAAAA;AAAAA,EAAO,CAC/B;AAID,MAFAL,QAAQS,WAEJ,CAACF,iBAAiB;AACpBjB,WAAOoB,MAAM,sDAAsD,GACnEpB,OAAOoB,MAAM,8CAA8C,GAC3DpB,OAAOoB,MAAM,sBAAsB;AACnC;AAAA,EACF;AAGApB,SAAOoB,MAAM,EAAE;AAEf,QAAMC,aAAaJ,gBAAgBK,YAAY,YACzCC,MAAMF,aACRtB,MAAMyB,OAAOP,gBAAgBF,OAAO,IACpC,WAAWhB,MAAMyB,OAAOP,gBAAgBF,OAAO,CAAC;AAQpD,MAAI,EAH2BZ,MAAMsB,OAAOtB,MAAMuB,IAG7B;AACnB,UAAMC,iBAAiBN,aACnB,+CAA+CE,GAAG;AAAA,YAC9CxB,MAAM6B,IAAI,MAAM,CAAC,6BACrB,sBAAsBL,GAAG;AAAA;AAAA,YAErBxB,MAAM6B,IAAI,MAAM,CAAC;AAQzB,QAAI,CANmB,MAAM3B,OAAO4B,OAAO;AAAA,MACzCC,MAAM;AAAA,MACNC,SAAS;AAAA,MACTC,SAASL,eAAeM,KAAAA;AAAAA,IAAK,CAC9B;AAGC;AAAA,EAEJ;AAEAvB,YAAUV,OAAOU,QAAQW,aAAa,yBAAyB,oBAAoB,EAAEV,MAAAA;AACrF,MAAI;AACF,UAAMuB,sBAAsB;AAAA,MAC1B7B;AAAAA,MACA8B,eAAelB,gBAAgBmB;AAAAA,MAC/BC,SAAS;AAAA,IAAA,CACV,GACD3B,QAAQS,QAAAA;AAAAA,EACV,SAASmB,KAAK;AACZ5B,UAAAA,QAAQ6B,KAAAA,GACR/C,MAAM,4BAA4B8C,GAAG,GAC/BA;AAAAA,EACR;AAEAtC,SAAOoB,MACLC,aACI,kCACA,iEAAiEE,GAAG,kBAC1E;AACF;"}