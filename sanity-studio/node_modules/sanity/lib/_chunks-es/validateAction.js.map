{"version":3,"file":"validateAction.js","sources":["../../src/_internal/cli/actions/schema/metafile.ts","../../src/_internal/cli/actions/schema/validateAction.ts"],"sourcesContent":["import {type SeralizedSchemaDebug, type SerializedTypeDebug} from '../../threads/validateSchema'\n\n// This implements the metafile format of ESBuild.\ntype Metafile = {\n  inputs: Record<string, MetafileInput>\n  outputs: Record<string, MetafileOutput>\n}\n\ntype MetafileOutput = {\n  imports: []\n  exports: []\n  inputs: Record<string, {bytesInOutput: number}>\n  bytes: number\n}\n\ntype MetafileInput = {\n  bytes: number\n  imports: []\n  format: 'esm' | 'csj'\n}\n\n/** Converts the  */\nexport function generateMetafile(schema: SeralizedSchemaDebug): Metafile {\n  const output: MetafileOutput = {\n    imports: [],\n    exports: [],\n    inputs: {},\n    bytes: 0,\n  }\n\n  // Generate a esbuild metafile\n  const inputs: Record<string, MetafileInput> = {}\n\n  function processType(path: string, entry: SerializedTypeDebug) {\n    let childSize = 0\n\n    if (entry.fields) {\n      for (const [name, fieldEntry] of Object.entries(entry.fields)) {\n        processType(`${path}/${name}`, fieldEntry)\n        childSize += fieldEntry.size\n      }\n    }\n\n    if (entry.of) {\n      for (const [name, fieldEntry] of Object.entries(entry.of)) {\n        processType(`${path}/${name}`, fieldEntry)\n        childSize += fieldEntry.size\n      }\n    }\n\n    const selfSize = entry.size - childSize\n\n    inputs[path] = {\n      bytes: selfSize,\n      imports: [],\n      format: 'esm',\n    }\n\n    output.inputs[path] = {\n      bytesInOutput: selfSize,\n    }\n\n    output.bytes += selfSize\n  }\n\n  for (const [name, entry] of Object.entries(schema.types)) {\n    const fakePath = `schema/${entry.extends}/${name}`\n    processType(fakePath, entry)\n  }\n\n  for (const [name, entry] of Object.entries(schema.hoisted)) {\n    const fakePath = `hoisted/${name}`\n    processType(fakePath, entry)\n  }\n\n  return {outputs: {root: output}, inputs}\n}\n","import {writeFileSync} from 'node:fs'\nimport path from 'node:path'\nimport {fileURLToPath} from 'node:url'\nimport {Worker} from 'node:worker_threads'\n\nimport {type CliCommandArguments, type CliCommandContext} from '@sanity/cli'\nimport logSymbols from 'log-symbols'\nimport readPkgUp from 'read-pkg-up'\n\nimport {\n  type ValidateSchemaWorkerData,\n  type ValidateSchemaWorkerResult,\n} from '../../threads/validateSchema'\nimport {formatSchemaValidation, getAggregatedSeverity} from './formatSchemaValidation'\nimport {generateMetafile} from './metafile'\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url))\n\ninterface ValidateFlags {\n  'workspace'?: string\n  'format'?: string\n  'level'?: 'error' | 'warning'\n  'debug-metafile-path'?: string\n}\n\nexport type SchemaValidationFormatter = (result: ValidateSchemaWorkerResult) => string\n\nexport default async function validateAction(\n  args: CliCommandArguments<ValidateFlags>,\n  {workDir, output}: CliCommandContext,\n): Promise<void> {\n  const flags = args.extOptions\n\n  const rootPkgPath = readPkgUp.sync({cwd: __dirname})?.path\n  if (!rootPkgPath) {\n    throw new Error('Could not find root directory for `sanity` package')\n  }\n\n  const workerPath = path.join(\n    path.dirname(rootPkgPath),\n    'lib',\n    '_internal',\n    'cli',\n    'threads',\n    'validateSchema.cjs',\n  )\n\n  const level = flags.level || 'warning'\n\n  if (level !== 'error' && level !== 'warning') {\n    throw new Error(`Invalid level. Available levels are 'error' and 'warning'.`)\n  }\n\n  const format = flags.format || 'pretty'\n\n  if (!['pretty', 'ndjson', 'json'].includes(format)) {\n    throw new Error(\n      `Did not recognize format '${flags.format}'. Available formats are 'pretty', 'ndjson', and 'json'.`,\n    )\n  }\n\n  let spinner\n\n  if (format === 'pretty') {\n    spinner = output\n      .spinner(\n        flags.workspace\n          ? `Validating schema from workspace '${flags.workspace}'…`\n          : 'Validating schema…',\n      )\n      .start()\n  }\n\n  const worker = new Worker(workerPath, {\n    workerData: {\n      workDir,\n      level,\n      workspace: flags.workspace,\n      debugSerialize: Boolean(flags['debug-metafile-path']),\n    } satisfies ValidateSchemaWorkerData,\n    env: process.env,\n  })\n\n  const {validation, serializedDebug} = await new Promise<ValidateSchemaWorkerResult>(\n    (resolve, reject) => {\n      worker.addListener('message', resolve)\n      worker.addListener('error', reject)\n    },\n  )\n\n  const problems = validation.flatMap((group) => group.problems)\n  const errorCount = problems.filter((problem) => problem.severity === 'error').length\n  const warningCount = problems.filter((problem) => problem.severity === 'warning').length\n\n  const overallSeverity = getAggregatedSeverity(validation)\n  const didFail = overallSeverity === 'error'\n\n  if (flags['debug-metafile-path'] && !didFail) {\n    if (!serializedDebug) throw new Error('serializedDebug should always be produced')\n    const metafile = generateMetafile(serializedDebug)\n    writeFileSync(flags['debug-metafile-path'], JSON.stringify(metafile), 'utf8')\n  }\n\n  switch (format) {\n    case 'ndjson': {\n      for (const group of validation) {\n        output.print(JSON.stringify(group))\n      }\n      break\n    }\n    case 'json': {\n      output.print(JSON.stringify(validation))\n      break\n    }\n    default: {\n      spinner?.succeed('Validated schema')\n      output.print(`\\nValidation results:`)\n      output.print(\n        `${logSymbols.error} Errors:   ${errorCount.toLocaleString('en-US')} error${\n          errorCount === 1 ? '' : 's'\n        }`,\n      )\n      if (level !== 'error') {\n        output.print(\n          `${logSymbols.warning} Warnings: ${warningCount.toLocaleString('en-US')} warning${\n            warningCount === 1 ? '' : 's'\n          }`,\n        )\n      }\n      output.print()\n\n      output.print(formatSchemaValidation(validation))\n\n      if (flags['debug-metafile-path']) {\n        output.print()\n        if (didFail) {\n          output.print(`${logSymbols.info} Metafile not written due to validation errors`)\n        } else {\n          output.print(`${logSymbols.info} Metafile written to: ${flags['debug-metafile-path']}`)\n          output.print(`  This can be analyzed at https://esbuild.github.io/analyze/`)\n        }\n      }\n    }\n  }\n\n  process.exitCode = didFail ? 1 : 0\n}\n"],"names":["generateMetafile","schema","output","imports","exports","inputs","bytes","processType","path","entry","childSize","fields","name","fieldEntry","Object","entries","size","of","selfSize","format","bytesInOutput","types","fakePath","extends","hoisted","outputs","root","__dirname","dirname","fileURLToPath","import","url","validateAction","args","workDir","flags","extOptions","rootPkgPath","readPkgUp","sync","cwd","Error","workerPath","join","level","includes","spinner","workspace","start","worker","Worker","workerData","debugSerialize","Boolean","env","process","validation","serializedDebug","Promise","resolve","reject","addListener","problems","flatMap","group","errorCount","filter","problem","severity","length","warningCount","didFail","getAggregatedSeverity","metafile","writeFileSync","JSON","stringify","print","succeed","logSymbols","error","toLocaleString","warning","formatSchemaValidation","info","exitCode"],"mappings":";;;;;;;AAsBO,SAASA,iBAAiBC,QAAwC;AACvE,QAAMC,SAAyB;AAAA,IAC7BC,SAAS,CAAA;AAAA,IACTC,SAAS,CAAA;AAAA,IACTC,QAAQ,CAAA;AAAA,IACRC,OAAO;AAAA,EAAA,GAIHD,SAAwC,CAAA;AAE9C,WAASE,YAAYC,OAAcC,OAA4B;AAC7D,QAAIC,YAAY;AAEhB,QAAID,MAAME;AACR,iBAAW,CAACC,MAAMC,UAAU,KAAKC,OAAOC,QAAQN,MAAME,MAAM;AAC1DJ,oBAAY,GAAGC,KAAI,IAAII,IAAI,IAAIC,UAAU,GACzCH,aAAaG,WAAWG;AAI5B,QAAIP,MAAMQ;AACR,iBAAW,CAACL,MAAMC,UAAU,KAAKC,OAAOC,QAAQN,MAAMQ,EAAE;AACtDV,oBAAY,GAAGC,KAAI,IAAII,IAAI,IAAIC,UAAU,GACzCH,aAAaG,WAAWG;AAI5B,UAAME,WAAWT,MAAMO,OAAON;AAE9BL,WAAOG,KAAI,IAAI;AAAA,MACbF,OAAOY;AAAAA,MACPf,SAAS,CAAA;AAAA,MACTgB,QAAQ;AAAA,IAAA,GAGVjB,OAAOG,OAAOG,KAAI,IAAI;AAAA,MACpBY,eAAeF;AAAAA,IAAAA,GAGjBhB,OAAOI,SAASY;AAAAA,EAClB;AAEA,aAAW,CAACN,MAAMH,KAAK,KAAKK,OAAOC,QAAQd,OAAOoB,KAAK,GAAG;AACxD,UAAMC,WAAW,UAAUb,MAAMc,OAAO,IAAIX,IAAI;AAChDL,gBAAYe,UAAUb,KAAK;AAAA,EAC7B;AAEA,aAAW,CAACG,MAAMH,KAAK,KAAKK,OAAOC,QAAQd,OAAOuB,OAAO,GAAG;AAC1D,UAAMF,WAAW,WAAWV,IAAI;AAChCL,gBAAYe,UAAUb,KAAK;AAAA,EAC7B;AAEA,SAAO;AAAA,IAACgB,SAAS;AAAA,MAACC,MAAMxB;AAAAA,IAAAA;AAAAA,IAASG;AAAAA,EAAAA;AACnC;AC5DA,MAAMsB,cAAYnB,KAAKoB,QAAQC,cAAcC,YAAYC,GAAG,CAAC;AAW7D,eAA8BC,eAC5BC,MACA;AAAA,EAACC;AAAAA,EAAShC;AAAyB,GACpB;AACf,QAAMiC,QAAQF,KAAKG,YAEbC,cAAcC,UAAUC,KAAK;AAAA,IAACC,KAAKb;AAAAA,EAAAA,CAAU,GAAGnB;AACtD,MAAI,CAAC6B;AACH,UAAM,IAAII,MAAM,oDAAoD;AAGtE,QAAMC,aAAalC,KAAKmC,KACtBnC,KAAKoB,QAAQS,WAAW,GACxB,OACA,aACA,OACA,WACA,oBACF,GAEMO,QAAQT,MAAMS,SAAS;AAE7B,MAAIA,UAAU,WAAWA,UAAU;AACjC,UAAM,IAAIH,MAAM,4DAA4D;AAG9E,QAAMtB,SAASgB,MAAMhB,UAAU;AAE/B,MAAI,CAAC,CAAC,UAAU,UAAU,MAAM,EAAE0B,SAAS1B,MAAM;AAC/C,UAAM,IAAIsB,MACR,6BAA6BN,MAAMhB,MAAM,0DAC3C;AAGF,MAAI2B;AAEA3B,aAAW,aACb2B,UAAU5C,OACP4C,QACCX,MAAMY,YACF,qCAAqCZ,MAAMY,SAAS,YACpD,yBACN,EACCC;AAGL,QAAMC,SAAS,IAAIC,OAAOR,YAAY;AAAA,IACpCS,YAAY;AAAA,MACVjB;AAAAA,MACAU;AAAAA,MACAG,WAAWZ,MAAMY;AAAAA,MACjBK,gBAAgBC,CAAAA,CAAQlB,MAAM,qBAAqB;AAAA,IAAA;AAAA,IAErDmB,KAAKC,QAAQD;AAAAA,EAAAA,CACd,GAEK;AAAA,IAACE;AAAAA,IAAYC;AAAAA,EAAAA,IAAmB,MAAM,IAAIC,QAC9C,CAACC,SAASC,WAAW;AACnBX,WAAOY,YAAY,WAAWF,OAAO,GACrCV,OAAOY,YAAY,SAASD,MAAM;AAAA,EACpC,CACF,GAEME,WAAWN,WAAWO,QAASC,CAAAA,UAAUA,MAAMF,QAAQ,GACvDG,aAAaH,SAASI,OAAQC,aAAYA,QAAQC,aAAa,OAAO,EAAEC,QACxEC,eAAeR,SAASI,OAAQC,CAAAA,YAAYA,QAAQC,aAAa,SAAS,EAAEC,QAG5EE,UADkBC,sBAAsBhB,UAAU,MACpB;AAEpC,MAAIrB,MAAM,qBAAqB,KAAK,CAACoC,SAAS;AAC5C,QAAI,CAACd,gBAAiB,OAAM,IAAIhB,MAAM,2CAA2C;AACjF,UAAMgC,WAAWzE,iBAAiByD,eAAe;AACjDiB,kBAAcvC,MAAM,qBAAqB,GAAGwC,KAAKC,UAAUH,QAAQ,GAAG,MAAM;AAAA,EAC9E;AAEA,UAAQtD,QAAAA;AAAAA,IACN,KAAK,UAAU;AACb,iBAAW6C,SAASR;AAClBtD,eAAO2E,MAAMF,KAAKC,UAAUZ,KAAK,CAAC;AAEpC;AAAA,IACF;AAAA,IACA,KAAK,QAAQ;AACX9D,aAAO2E,MAAMF,KAAKC,UAAUpB,UAAU,CAAC;AACvC;AAAA,IACF;AAAA,IACA;AACEV,eAASgC,QAAQ,kBAAkB,GACnC5E,OAAO2E,MAAM;AAAA,oBAAuB,GACpC3E,OAAO2E,MACL,GAAGE,WAAWC,KAAK,cAAcf,WAAWgB,eAAe,OAAO,CAAC,SACjEhB,eAAe,IAAI,KAAK,GAAG,EAE/B,GACIrB,UAAU,WACZ1C,OAAO2E,MACL,GAAGE,WAAWG,OAAO,cAAcZ,aAAaW,eAAe,OAAO,CAAC,WACrEX,iBAAiB,IAAI,KAAK,GAAG,EAEjC,GAEFpE,OAAO2E,MAAAA,GAEP3E,OAAO2E,MAAMM,uBAAuB3B,UAAU,CAAC,GAE3CrB,MAAM,qBAAqB,MAC7BjC,OAAO2E,MAAAA,GACHN,UACFrE,OAAO2E,MAAM,GAAGE,WAAWK,IAAI,gDAAgD,KAE/ElF,OAAO2E,MAAM,GAAGE,WAAWK,IAAI,yBAAyBjD,MAAM,qBAAqB,CAAC,EAAE,GACtFjC,OAAO2E,MAAM,8DAA8D;AAAA,EAAA;AAMnFtB,UAAQ8B,WAAWd,UAAU,IAAI;AACnC;"}