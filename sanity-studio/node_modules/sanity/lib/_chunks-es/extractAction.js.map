{"version":3,"file":"extractAction.js","sources":["../../src/_internal/cli/actions/schema/extractAction.ts"],"sourcesContent":["import {join} from 'node:path'\n\nimport {type CliCommandArguments, type CliCommandContext} from '@sanity/cli'\nimport {mean, once} from 'lodash-es'\n\nimport {promiseWithResolvers} from '../../util/promiseWithResolvers'\nimport {SchemaExtractedTrace, SchemaExtractionWatchModeTrace} from './extractSchema.telemetry'\nimport {formatSchemaValidation} from './formatSchemaValidation'\nimport {\n  DEFAULT_WATCH_PATTERNS,\n  extractSchemaToFile,\n  SchemaExtractionError,\n  startSchemaWatcher,\n} from './schemaExtractorApi'\n\nexport interface ExtractFlags {\n  'workspace'?: string\n  'path'?: string\n  'enforce-required-fields'?: boolean\n  'format'?: 'groq-type-nodes' | string\n  'watch'?: boolean\n  'watch-patterns'?: string | string[]\n}\n\nexport default async function extractAction(\n  args: CliCommandArguments<ExtractFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const flags = args.extOptions\n\n  if (flags.watch) {\n    return runWatchMode(args, context)\n  }\n\n  return runSingleExtraction(args, context)\n}\n\nexport function getExtractOptions(\n  flags: ExtractFlags,\n  config: CliCommandContext['cliConfig'],\n  workDir: string,\n) {\n  const schemaExtraction = config?.schemaExtraction\n\n  return {\n    workspace: flags.workspace ?? schemaExtraction?.workspace,\n    format: flags.format ?? 'groq-type-nodes',\n    enforceRequiredFields:\n      flags['enforce-required-fields'] ?? schemaExtraction?.enforceRequiredFields ?? false,\n    outputPath: flags.path ?? schemaExtraction?.path ?? join(workDir, 'schema.json'),\n    watchPatterns: flags['watch-patterns']\n      ? Array.isArray(flags['watch-patterns'])\n        ? flags['watch-patterns']\n        : [flags['watch-patterns']]\n      : (schemaExtraction?.watchPatterns ?? []),\n  }\n}\n\n/**\n * Runs a single extraction with spinner and telemetry (original behavior).\n */\nasync function runSingleExtraction(\n  args: CliCommandArguments<ExtractFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const flags = args.extOptions\n  const {workDir, output, telemetry, cliConfig} = context\n  const {\n    format,\n    enforceRequiredFields,\n    outputPath,\n    workspace: workspaceName,\n  } = getExtractOptions(flags, cliConfig, workDir)\n\n  const spinner = output\n    .spinner({})\n    .start(\n      enforceRequiredFields\n        ? 'Extracting schema, with enforced required fields'\n        : 'Extracting schema',\n    )\n\n  const trace = telemetry.trace(SchemaExtractedTrace)\n  trace.start()\n\n  try {\n    const schema = await extractSchemaToFile({\n      workDir,\n      outputPath,\n      workspaceName,\n      enforceRequiredFields,\n      format,\n    })\n\n    trace.log({\n      schemaAllTypesCount: schema.length,\n      schemaDocumentTypesCount: schema.filter((type) => type.type === 'document').length,\n      schemaTypesCount: schema.filter((type) => type.type === 'type').length,\n      enforceRequiredFields,\n      schemaFormat: format,\n    })\n\n    trace.complete()\n\n    spinner.succeed(\n      enforceRequiredFields\n        ? `Extracted schema to ${outputPath} with enforced required fields`\n        : `Extracted schema to ${outputPath}`,\n    )\n  } catch (err) {\n    trace.error(err)\n    spinner.fail(\n      enforceRequiredFields\n        ? 'Failed to extract schema, with enforced required fields'\n        : 'Failed to extract schema',\n    )\n\n    // Display validation errors if available\n    if (err instanceof SchemaExtractionError && err.validation && err.validation.length > 0) {\n      output.print('')\n      output.print(formatSchemaValidation(err.validation))\n    }\n\n    throw err\n  }\n}\n\n/**\n * Runs schema extraction in watch mode, re-extracting on file changes.\n */\nasync function runWatchMode(\n  args: CliCommandArguments<ExtractFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const flags = args.extOptions\n\n  // Keep the start time + some simple stats for extractions as they happen\n  const startTime = Date.now()\n  const stats: {successfulDurations: number[]; failedCount: number} = {\n    successfulDurations: [],\n    failedCount: 0,\n  }\n\n  const {workDir, output, telemetry, cliConfig} = context\n  const options = getExtractOptions(flags, cliConfig, workDir)\n  const {\n    format,\n    enforceRequiredFields,\n    outputPath,\n    watchPatterns: additionalPatterns,\n    workspace: workspaceName,\n  } = options\n  const watchPatterns = [...DEFAULT_WATCH_PATTERNS, ...additionalPatterns]\n\n  const trace = telemetry.trace(SchemaExtractionWatchModeTrace)\n  trace.start()\n\n  // Print watch mode header and patterns at the very beginning\n  output.print('Schema extraction watch mode')\n  output.print('')\n  output.print('Watching for changes in:')\n  for (const pattern of watchPatterns) {\n    output.print(`  - ${pattern}`)\n  }\n  output.print('')\n\n  output.print('Running initial extraction...')\n\n  // Start the watcher (includes initial extraction)\n  const {stop} = await startSchemaWatcher({\n    workDir,\n    outputPath,\n    output,\n    workspaceName,\n    enforceRequiredFields,\n    format,\n    patterns: watchPatterns,\n    onExtraction: ({success, duration}) => {\n      if (success) {\n        stats.successfulDurations.push(duration)\n      } else {\n        stats.failedCount++\n      }\n    },\n  })\n\n  trace.log({\n    step: 'started',\n    enforceRequiredFields,\n    schemaFormat: format,\n  })\n\n  output.print('')\n  output.print('Watching for changes... (Ctrl+C to stop)')\n\n  const {resolve, promise} = promiseWithResolvers<void>()\n\n  /**\n   * Handle graceful shutdown. Wrapped in once to prevent it being called twice by the\n   * SIGINT/SIGTERM callbacks, causing double trace logs etc..\n   */\n  const cleanup = once(() => {\n    trace.log({\n      step: 'stopped',\n      watcherDuration: Date.now() - startTime,\n      averageExtractionDuration: mean(stats.successfulDurations),\n      extractionSuccessfulCount: stats.successfulDurations.length,\n      extractionFailedCount: stats.failedCount,\n    })\n    trace.complete()\n\n    output.print('')\n    output.print('Stopping watch mode...')\n    void stop()\n    resolve()\n  })\n\n  process.on('SIGINT', cleanup)\n  process.on('SIGTERM', cleanup)\n\n  // Keep process alive\n  await promise\n}\n"],"names":["extractAction","args","context","extOptions","watch","runWatchMode","runSingleExtraction","getExtractOptions","flags","config","workDir","schemaExtraction","workspace","format","enforceRequiredFields","outputPath","path","join","watchPatterns","Array","isArray","output","telemetry","cliConfig","workspaceName","spinner","start","trace","SchemaExtractedTrace","schema","extractSchemaToFile","log","schemaAllTypesCount","length","schemaDocumentTypesCount","filter","type","schemaTypesCount","schemaFormat","complete","succeed","err","error","fail","SchemaExtractionError","validation","print","formatSchemaValidation","startTime","Date","now","stats","successfulDurations","failedCount","options","additionalPatterns","DEFAULT_WATCH_PATTERNS","SchemaExtractionWatchModeTrace","pattern","stop","startSchemaWatcher","patterns","onExtraction","success","duration","push","step","resolve","promise","promiseWithResolvers","cleanup","once","watcherDuration","averageExtractionDuration","mean","extractionSuccessfulCount","extractionFailedCount","process","on"],"mappings":"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"}