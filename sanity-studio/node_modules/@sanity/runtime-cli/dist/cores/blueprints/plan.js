import { getStack } from '../../actions/blueprints/stacks.js';
import { formatResourceTree, stackDeployDiff } from '../../utils/display/blueprints-formatting.js';
import { styleText } from '../../utils/style-text.js';
export async function blueprintPlanCore(options) {
    const { bin = 'sanity', log, blueprint, token, flags } = options;
    const { verbose: _verbose = false } = flags;
    const { scopeType, scopeId, stackId, parsedBlueprint, fileInfo } = blueprint;
    log(`${styleText(['bold', 'blueBright'], 'Blueprint Stack deployment plan')} ${styleText('dim', `(${fileInfo.fileName})`)}`);
    log(formatResourceTree(parsedBlueprint.resources));
    if (token && scopeType && scopeId && stackId) {
        const stackResponse = await getStack({
            auth: { token, scopeType, scopeId },
            stackId,
            logger: log,
        });
        if (!stackResponse.ok) {
            log(styleText('dim', 'Unable to retrieve live Stack deployment for comparison'));
        }
        else {
            const diff = stackDeployDiff(parsedBlueprint, stackResponse.stack);
            if (diff)
                log(diff);
        }
    }
    log(`\n  Run "${styleText(['bold', 'magenta'], `${bin} blueprints deploy`)}" to deploy these Stack changes`);
    return { success: true };
}
