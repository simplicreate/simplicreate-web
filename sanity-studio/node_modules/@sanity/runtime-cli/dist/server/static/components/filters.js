import {ApiBaseElement} from './api-base.js'
import {getSharedStyleSheets} from './shared-styles.js'

const template = document.createElement('template')
template.innerHTML = `
<style>
:host {
  grid-area: filters;
}

form {
  display: block;
  padding: var(--m-space-3);
  border-bottom: 1px solid var(--card-border-color);
}

form > * {
  display: block;
  width: 100%;
  margin-bottom: var(--m-space-3);
}

form > *:last-child {
  margin-bottom: 0;
}

form label {
  display: block;
  margin-bottom: var(--m-space-1);
}

form input {
  width: 100%;
  box-sizing: border-box;
}

@media (min-width: 40em) {
  form {
    display: flex;
    flex-direction: row;
    align-items: flex-end;
    gap: var(--m-space-3);
    padding-left: var(--m-space-3);
    padding-bottom: var(--m-space-3);
  }

  form > * {
    width: auto;
    margin-bottom: 0;
  }

  form fieldset {
    min-width: 150px;
  }
}
</style>
<form class="gap-2 pad-l-3 pad-b-3 border-bottom">
  <fieldset class="flex gap-2">
  </fieldset>
</form>
`

class FiltersComponent extends ApiBaseElement {
  constructor() {
    super()
    this.attachShadow({mode: 'open'}).appendChild(template.content.cloneNode(true))
  }

  async connectedCallback() {
    const sheets = await getSharedStyleSheets()
    this.shadowRoot.adoptedStyleSheets = sheets

    this.renderFilters()
    this.api.subscribe(this.renderFilters, ['selectedFunctionType'])
  }

  renderFilters = () => {
    const docFunction = this.api.store.selectedFunctionType === this.SANITY_FUNCTION_DOCUMENT
    const mediaFunction = this.api.store.selectedFunctionType?.startsWith(
      this.SANITY_FUNCTION_MEDIA_LIBRARY_ASSET,
    )
    const scheduleFunction = this.api.store.selectedFunctionType === this.SANITY_FUNCTION_SCHEDULE

    const container = this.shadowRoot.querySelector('fieldset')
    container.innerHTML = this.buildFilters(docFunction, mediaFunction, scheduleFunction)
  }

  buildFilters = (docFunction, mediaFunction, scheduleFunction) => {
    return `
    <legend class="config-label">Client Options</legend>
    <div id="dynamic-dropdowns" class="flex gap-2">
      ${
        docFunction || scheduleFunction
          ? `<select-dropdown
        label="Project"
        store-key="projects"
        selected-key="selectedProject"
        value-prop="id"
        label-prop="displayName"
        trigger-fetch
      ></select-dropdown>
      <select-dropdown
        label="Dataset"
        store-key="datasets"
        selected-key="selectedDataset"
        value-prop="name"
        label-prop="name"
        subscribe-to="selectedProject"
      ></select-dropdown>`
          : `
      <select-dropdown
        label="Organization"
        store-key="organizations"
        selected-key="selectedOrganization"
        value-prop="id"
        label-prop="name"
        trigger-fetch
      ></select-dropdown>
      <select-dropdown
        label="Media Library"
        store-key="mediaLibraries"
        selected-key="selectedMediaLibrary"
        value-prop="id"
        label-prop="id"
        subscribe-to="selectedOrganization"
      ></select-dropdown>`
      }
    </div>
    ${
      docFunction || mediaFunction
        ? `<select-dropdown
      label="Event"
      store-key="events"
      selected-key="selectedEvent"
      value-prop="name"
      label-prop="name"
    ></select-dropdown>`
        : ''
    }
    <api-version></api-version>
    <with-token></with-token>
    ${docFunction || mediaFunction ? `<document-id></document-id>` : ''}
    `
  }

  disconnectedCallback() {
    this.api.unsubscribe(this.renderFilters)
  }
}

customElements.define('filters-component', FiltersComponent)
