{"version":3,"sources":["../../../src/utils/test/testLongRunning.ts"],"sourcesContent":["import {spawn} from 'node:child_process'\nimport path from 'node:path'\nimport {fileURLToPath} from 'node:url'\n\nimport {once} from 'lodash-es'\n\nconst BIN = path.resolve(path.dirname(fileURLToPath(import.meta.url)), '../../../bin/run.js')\n\ninterface Options {\n  expect: (o: {stderr: string; stdout: string}) => Promise<void> | void\n\n  cwd?: string\n  interval?: number\n  timeout?: number\n}\n\nconst isAssertionError = (e: unknown) => e instanceof Error && e.name === 'AssertionError'\n\nexport async function testLongRunning(\n  command: string[],\n  opts: Options,\n): Promise<{stderr: string; stdout: string}> {\n  const {cwd = process.cwd(), expect: assertion, interval = 150, timeout = 20_000} = opts\n  let stderr = '',\n    stdout = ''\n\n  // spawn command in child process\n  const child = spawn('node', [BIN, ...command], {\n    cwd,\n    env: {...process.env, NO_COLOR: '1'},\n    stdio: ['pipe', 'pipe', 'pipe'],\n  })\n\n  // track err and out\n  child.stdout?.on('data', (d) => (stdout += d))\n  child.stderr?.on('data', (d) => (stderr += d))\n\n  const kill = once(() => child.kill('SIGTERM'))\n\n  // track errors from the child process\n  let exitError: Error | null = null\n  child.on('exit', (code) => {\n    if (code === 0) return\n    exitError = new Error(`Process exited with code ${code}\\nstderr: ${stderr}`)\n  })\n\n  child.on('error', (e) => {\n    exitError = e\n  })\n\n  // assert once every interval until expectation met, error or timeout\n  const start = Date.now()\n  async function assertExpectation(): Promise<{stderr: string; stdout: string}> {\n    if (exitError) throw exitError\n\n    try {\n      await assertion({stderr, stdout})\n      return {stderr, stdout}\n    } catch (e) {\n      if (!isAssertionError(e)) throw e\n      if (Date.now() - start > timeout) throw e\n\n      return new Promise((resolve) => {\n        setTimeout(() => resolve(assertExpectation()), interval)\n      })\n    }\n  }\n\n  try {\n    return await assertExpectation()\n  } finally {\n    kill()\n  }\n}\n"],"names":["spawn","path","fileURLToPath","once","BIN","resolve","dirname","url","isAssertionError","e","Error","name","testLongRunning","command","opts","cwd","process","expect","assertion","interval","timeout","stderr","stdout","child","env","NO_COLOR","stdio","on","d","kill","exitError","code","start","Date","now","assertExpectation","Promise","setTimeout"],"mappings":"AAAA,SAAQA,KAAK,QAAO,qBAAoB;AACxC,OAAOC,UAAU,YAAW;AAC5B,SAAQC,aAAa,QAAO,WAAU;AAEtC,SAAQC,IAAI,QAAO,YAAW;AAE9B,MAAMC,MAAMH,KAAKI,OAAO,CAACJ,KAAKK,OAAO,CAACJ,cAAc,YAAYK,GAAG,IAAI;AAUvE,MAAMC,mBAAmB,CAACC,IAAeA,aAAaC,SAASD,EAAEE,IAAI,KAAK;AAE1E,OAAO,eAAeC,gBACpBC,OAAiB,EACjBC,IAAa;IAEb,MAAM,EAACC,MAAMC,QAAQD,GAAG,EAAE,EAAEE,QAAQC,SAAS,EAAEC,WAAW,GAAG,EAAEC,UAAU,MAAM,EAAC,GAAGN;IACnF,IAAIO,SAAS,IACXC,SAAS;IAEX,iCAAiC;IACjC,MAAMC,QAAQvB,MAAM,QAAQ;QAACI;WAAQS;KAAQ,EAAE;QAC7CE;QACAS,KAAK;YAAC,GAAGR,QAAQQ,GAAG;YAAEC,UAAU;QAAG;QACnCC,OAAO;YAAC;YAAQ;YAAQ;SAAO;IACjC;IAEA,oBAAoB;IACpBH,MAAMD,MAAM,EAAEK,GAAG,QAAQ,CAACC,IAAON,UAAUM;IAC3CL,MAAMF,MAAM,EAAEM,GAAG,QAAQ,CAACC,IAAOP,UAAUO;IAE3C,MAAMC,OAAO1B,KAAK,IAAMoB,MAAMM,IAAI,CAAC;IAEnC,sCAAsC;IACtC,IAAIC,YAA0B;IAC9BP,MAAMI,EAAE,CAAC,QAAQ,CAACI;QAChB,IAAIA,SAAS,GAAG;QAChBD,YAAY,IAAIpB,MAAM,CAAC,yBAAyB,EAAEqB,KAAK,UAAU,EAAEV,QAAQ;IAC7E;IAEAE,MAAMI,EAAE,CAAC,SAAS,CAAClB;QACjBqB,YAAYrB;IACd;IAEA,qEAAqE;IACrE,MAAMuB,QAAQC,KAAKC,GAAG;IACtB,eAAeC;QACb,IAAIL,WAAW,MAAMA;QAErB,IAAI;YACF,MAAMZ,UAAU;gBAACG;gBAAQC;YAAM;YAC/B,OAAO;gBAACD;gBAAQC;YAAM;QACxB,EAAE,OAAOb,GAAG;YACV,IAAI,CAACD,iBAAiBC,IAAI,MAAMA;YAChC,IAAIwB,KAAKC,GAAG,KAAKF,QAAQZ,SAAS,MAAMX;YAExC,OAAO,IAAI2B,QAAQ,CAAC/B;gBAClBgC,WAAW,IAAMhC,QAAQ8B,sBAAsBhB;YACjD;QACF;IACF;IAEA,IAAI;QACF,OAAO,MAAMgB;IACf,SAAU;QACRN;IACF;AACF"}