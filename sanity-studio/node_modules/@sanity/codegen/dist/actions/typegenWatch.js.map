{"version":3,"sources":["../../src/actions/typegenWatch.ts"],"sourcesContent":["import {error, log} from 'node:console'\nimport {isAbsolute, join, relative} from 'node:path'\nimport {styleText} from 'node:util'\n\nimport chokidar, {FSWatcher} from 'chokidar'\nimport {debounce, mean} from 'lodash-es'\n\nimport {TypegenWatchModeTraceAttributes} from '../typegen.telemetry.js'\nimport {prepareConfig} from '../utils/config.js'\nimport {runTypegenGenerate} from './typegenGenerate.js'\nimport {type RunTypegenOptions} from './types.js'\n\nconst IGNORED_PATTERNS = [\n  '**/node_modules/**',\n  '**/.git/**',\n  '**/dist/**',\n  '**/lib/**',\n  '**/.sanity/**',\n]\n\n/** State for tracking generation status */\ninterface WatchState {\n  isGenerating: boolean\n  pendingGeneration: boolean\n}\n\n/** Return type for createTypegenRunner */\ninterface TypegenRunner {\n  runGeneration: () => Promise<void>\n  state: WatchState\n}\n\ntype WatcherStats = Omit<Extract<TypegenWatchModeTraceAttributes, {step: 'stopped'}>, 'step'>\n\n/**\n * Creates a typegen runner with concurrency control.\n * If generation is already running, queues one more generation to run after completion.\n * Multiple queued requests are coalesced into a single pending generation.\n */\nfunction createTypegenRunner(onGenerate: () => Promise<unknown>): TypegenRunner {\n  const state: WatchState = {\n    isGenerating: false,\n    pendingGeneration: false,\n  }\n\n  async function runGeneration(): Promise<void> {\n    if (state.isGenerating) {\n      state.pendingGeneration = true\n      return\n    }\n\n    state.isGenerating = true\n    state.pendingGeneration = false\n\n    try {\n      await onGenerate()\n    } finally {\n      state.isGenerating = false\n\n      // If a change came in during generation, run again\n      if (state.pendingGeneration) {\n        state.pendingGeneration = false\n        await runGeneration()\n      }\n    }\n  }\n\n  return {runGeneration, state}\n}\n\n/**\n * Starts a file watcher that triggers typegen on changes.\n * Watches both query files (via patterns) and the schema JSON file.\n * Implements debouncing and concurrency control to prevent multiple generations.\n */\nexport function runTypegenWatcher(options: RunTypegenOptions): {\n  getStats: () => WatcherStats\n  stop: () => Promise<void>\n  watcher: FSWatcher\n} {\n  const {config, workDir} = options\n  const {path, schema} = prepareConfig(config)\n\n  const stats = {\n    failedCount: 0,\n    startTime: Date.now(),\n    successfulDurations: [] as number[],\n  }\n\n  const {runGeneration} = createTypegenRunner(async () => {\n    try {\n      const {duration} = await runTypegenGenerate({...options})\n      stats.successfulDurations.push(duration)\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : err\n      error(` ${styleText('red', 'â€º')}   ${errorMessage}`)\n      stats.failedCount++\n    }\n  })\n\n  // Debounced generation trigger\n  const debouncedGenerate = debounce(runGeneration, 1000)\n\n  // Build absolute patterns for query files and schema file\n  const paths = Array.isArray(path) ? path : [path]\n  const absoluteQueryPatterns = paths.map((pattern) =>\n    isAbsolute(pattern) ? pattern : join(workDir, pattern),\n  )\n  const absoluteSchemaPath = isAbsolute(schema) ? schema : join(workDir, schema)\n  const watchTargets = [...absoluteQueryPatterns, absoluteSchemaPath]\n\n  // perform initial generation\n  debouncedGenerate()\n\n  // set up watcher\n  const watcher = chokidar.watch(watchTargets, {\n    cwd: workDir,\n    ignored: IGNORED_PATTERNS,\n    ignoreInitial: true,\n  })\n\n  watcher.on('all', (event: string, filePath: string) => {\n    const timestamp = new Date().toLocaleTimeString()\n    const relativePath = isAbsolute(filePath) ? relative(workDir, filePath) : filePath\n    log(`[${timestamp}] ${event}: ${relativePath}`)\n    debouncedGenerate()\n  })\n\n  watcher.on('error', (err: Error) => {\n    error(`Watcher error: ${err.message}`)\n  })\n\n  return {\n    getStats: () => ({\n      averageGenerationDuration: mean(stats.successfulDurations) || 0,\n      generationFailedCount: stats.failedCount,\n      generationSuccessfulCount: stats.successfulDurations.length,\n      watcherDuration: Date.now() - stats.startTime,\n    }),\n    stop: async () => {\n      await watcher.close()\n    },\n    watcher,\n  }\n}\n"],"names":["error","log","isAbsolute","join","relative","styleText","chokidar","debounce","mean","prepareConfig","runTypegenGenerate","IGNORED_PATTERNS","createTypegenRunner","onGenerate","state","isGenerating","pendingGeneration","runGeneration","runTypegenWatcher","options","config","workDir","path","schema","stats","failedCount","startTime","Date","now","successfulDurations","duration","push","err","errorMessage","Error","message","debouncedGenerate","paths","Array","isArray","absoluteQueryPatterns","map","pattern","absoluteSchemaPath","watchTargets","watcher","watch","cwd","ignored","ignoreInitial","on","event","filePath","timestamp","toLocaleTimeString","relativePath","getStats","averageGenerationDuration","generationFailedCount","generationSuccessfulCount","length","watcherDuration","stop","close"],"mappings":"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"}