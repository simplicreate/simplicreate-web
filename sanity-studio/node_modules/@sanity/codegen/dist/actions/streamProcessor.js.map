{"version":3,"sources":["../../src/actions/streamProcessor.ts"],"sourcesContent":["import {writeFile} from 'node:fs/promises'\n\nimport {spinner} from '@sanity/cli-core/ux'\nimport {WorkerChannelReceiver} from '@sanity/worker-channels'\nimport {format, resolveConfig as resolvePrettierConfig} from 'prettier'\n\nimport {TypeGenConfig} from '../readConfig.js'\nimport {count} from '../utils/count.js'\nimport {debug} from '../utils/debug.js'\nimport {formatPath} from '../utils/formatPath.js'\nimport {getMessage} from '../utils/getMessage.js'\nimport {percent} from '../utils/percent.js'\nimport {generatedFileWarning} from './generatedFileWarning.js'\nimport {TypegenWorkerChannel} from './types.js'\n\n/**\n * Processes the event stream from a typegen worker thread.\n *\n * Listens to worker channel events, displays progress via CLI spinners,\n * writes the generated types to disk, and optionally formats with prettier.\n *\n * @param receiver - Worker channel receiver for typegen events\n * @param options - Typegen configuration options\n * @returns Generation result containing the generated code and statistics\n */\nexport async function processTypegenWorkerStream(\n  receiver: WorkerChannelReceiver<TypegenWorkerChannel>,\n  options: TypeGenConfig,\n) {\n  const start = Date.now()\n  const {formatGeneratedCode, generates, schema} = options\n  let code = ''\n\n  const spin = spinner().start(`Loading schema…`)\n\n  try {\n    await receiver.event.loadedSchema()\n    spin.succeed(`Schema loaded from ${formatPath(schema ?? '')}`)\n\n    spin.start('Generating schema types…')\n    const {expectedFileCount} = await receiver.event.typegenStarted()\n    const {schemaTypeDeclarations} = await receiver.event.generatedSchemaTypes()\n    const schemaTypesCount = schemaTypeDeclarations.length\n\n    spin.text = 'Generating query types…'\n\n    let queriesCount = 0\n    let evaluatedFiles = 0\n    let filesWithErrors = 0\n    let queryFilesCount = 0\n    let typeNodesGenerated = 0\n    let unknownTypeNodesGenerated = 0\n    let emptyUnionTypeNodesGenerated = 0\n\n    for await (const {errors, queries} of receiver.stream.evaluatedModules()) {\n      evaluatedFiles++\n      queriesCount += queries.length\n      queryFilesCount += queries.length > 0 ? 1 : 0\n      filesWithErrors += errors.length > 0 ? 1 : 0\n\n      for (const {stats} of queries) {\n        typeNodesGenerated += stats.allTypes\n        unknownTypeNodesGenerated += stats.unknownTypes\n        emptyUnionTypeNodesGenerated += stats.emptyUnions\n      }\n\n      for (const error of errors) {\n        spin.fail(getMessage(error))\n      }\n\n      if (!spin.isSpinning) {\n        spin.start()\n      }\n\n      spin.text =\n        `Generating query types… (${percent(evaluatedFiles / expectedFileCount)})\\n` +\n        `  └─ Processed ${count(evaluatedFiles)} of ${count(expectedFileCount, 'files')}. ` +\n        `Found ${count(queriesCount, 'queries', 'query')} from ${count(queryFilesCount, 'files')}.`\n    }\n\n    const result = await receiver.event.typegenComplete()\n    code = `${generatedFileWarning}${result.code}`\n    await writeFile(generates, code)\n\n    let formattingError = false\n    if (formatGeneratedCode) {\n      spin.text = `Formatting generated types with prettier…`\n\n      try {\n        const prettierConfig = await resolvePrettierConfig(generates)\n        const formattedCode = await format(code, {\n          ...prettierConfig,\n          parser: 'typescript' as const,\n        })\n        await writeFile(generates, formattedCode)\n      } catch (err) {\n        formattingError = true\n        spin.warn(`Failed to format generated types with prettier: ${getMessage(err)}`)\n      }\n    }\n\n    if (filesWithErrors > 0) {\n      spin.warn(`Encountered errors in ${count(filesWithErrors, 'files')} while generating types`)\n    }\n\n    const stats = {\n      duration: Date.now() - start,\n      emptyUnionTypeNodesGenerated,\n      filesWithErrors,\n      outputSize: Buffer.byteLength(code),\n      queriesCount,\n      queryFilesCount,\n      schemaTypesCount,\n      typeNodesGenerated,\n      unknownTypeNodesGenerated,\n      unknownTypeNodesRatio:\n        typeNodesGenerated > 0 ? unknownTypeNodesGenerated / typeNodesGenerated : 0,\n    }\n\n    let successText =\n      `Successfully generated types to ${formatPath(generates)} in ${Number(stats.duration).toFixed(0)}ms` +\n      `\\n  └─ ${count(queriesCount, 'queries', 'query')} and ${count(schemaTypesCount, 'schema types', 'schema type')}` +\n      `\\n  └─ found queries in ${count(queryFilesCount, 'files', 'file')} after evaluating ${count(evaluatedFiles, 'files', 'file')}`\n\n    if (formatGeneratedCode) {\n      successText += `\\n  └─ ${formattingError ? 'an error occured during formatting' : 'formatted the generated code with prettier'}`\n    }\n\n    spin.succeed(successText)\n\n    return {\n      ...stats,\n      code,\n    }\n  } catch (err) {\n    spin.fail()\n    debug('error generating types', err)\n    throw err\n  } finally {\n    receiver.unsubscribe()\n  }\n}\n"],"names":["writeFile","spinner","format","resolveConfig","resolvePrettierConfig","count","debug","formatPath","getMessage","percent","generatedFileWarning","processTypegenWorkerStream","receiver","options","start","Date","now","formatGeneratedCode","generates","schema","code","spin","event","loadedSchema","succeed","expectedFileCount","typegenStarted","schemaTypeDeclarations","generatedSchemaTypes","schemaTypesCount","length","text","queriesCount","evaluatedFiles","filesWithErrors","queryFilesCount","typeNodesGenerated","unknownTypeNodesGenerated","emptyUnionTypeNodesGenerated","errors","queries","stream","evaluatedModules","stats","allTypes","unknownTypes","emptyUnions","error","fail","isSpinning","result","typegenComplete","formattingError","prettierConfig","formattedCode","parser","err","warn","duration","outputSize","Buffer","byteLength","unknownTypeNodesRatio","successText","Number","toFixed","unsubscribe"],"mappings":"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"}