{"version":3,"sources":["../../src/typescript/parseSource.ts"],"sourcesContent":["import type * as babelTypes from '@babel/types'\n\nimport {parse, type TransformOptions} from '@babel/core'\n\n// helper function to parse a source file\nexport function parseSourceFile(\n  _source: string,\n  _filename: string,\n  babelOptions: TransformOptions,\n): babelTypes.File {\n  let source = _source\n  let filename = _filename\n  if (filename.endsWith('.astro')) {\n    // append .ts to the filename so babel will parse it as typescript\n    filename += '.ts'\n    source = parseAstro(source)\n  } else if (filename.endsWith('.vue')) {\n    // append .ts to the filename so babel will parse it as typescript\n    filename += '.ts'\n    source = parseVue(source)\n  } else if (filename.endsWith('.svelte')) {\n    // append .ts to the filename so babel will parse it as typescript\n    filename += '.ts'\n    source = parseSvelte(source)\n  }\n  const result = parse(source, {\n    ...babelOptions,\n    filename,\n  })\n\n  if (!result) {\n    throw new Error(`Failed to parse ${filename}`)\n  }\n\n  return result\n}\n\nfunction parseAstro(source: string): string {\n  // find all code fences, the js code is between --- and ---\n  // Handle both Unix (\\n) and Windows (\\r\\n) line endings\n  const codeFences = source.match(/---\\r?\\n([\\s\\S]*?)\\r?\\n---/g)\n  if (!codeFences) {\n    return ''\n  }\n\n  return codeFences\n    .map((codeFence) => {\n      // Split on either \\n or \\r\\n\n      return codeFence.split(/\\r?\\n/).slice(1, -1).join('\\n')\n    })\n    .join('\\n')\n}\n\nfunction parseVue(source: string): string {\n  // find all script tags, the js code is between <script> and </script>\n  const scriptRegex = /<script(?:\\s+generic=[\"'][^\"']*[\"'])?[^>]*>([\\s\\S]*?)<\\/script>/g\n  // const matches = [...source.matchAll(scriptRegex)]\n  // TODO: swap once this code runs in `ES2020`\n  const matches = matchAllPolyfill(source, scriptRegex)\n  if (matches.length === 0) {\n    return ''\n  }\n\n  return matches.map((match) => match[1]).join('\\n')\n}\n\nfunction parseSvelte(source: string): string {\n  // find all script tags, the js code is between <script> and </script>\n  const scriptRegex = /<script[^>]*>([\\s\\S]*?)<\\/script>/g\n  // const matches = [...source.matchAll(scriptRegex)]\n  // TODO: swap once this code runs in `ES2020`\n  const matches = matchAllPolyfill(source, scriptRegex)\n  if (matches.length === 0) {\n    return ''\n  }\n\n  return matches.map((match) => match[1]).join('\\n')\n}\n\n// TODO: remove once this code runs in `ES2020`\nfunction matchAllPolyfill(str: string, regex: RegExp): RegExpMatchArray[] {\n  if (!regex.global) {\n    throw new Error('matchAll polyfill requires a global regex (with /g flag)')\n  }\n\n  const matches = []\n  let match\n  while ((match = regex.exec(str)) !== null) {\n    matches.push(match)\n  }\n  return matches\n}\n"],"names":["parse","parseSourceFile","_source","_filename","babelOptions","source","filename","endsWith","parseAstro","parseVue","parseSvelte","result","Error","codeFences","match","map","codeFence","split","slice","join","scriptRegex","matches","matchAllPolyfill","length","str","regex","global","exec","push"],"mappings":"AAEA,SAAQA,KAAK,QAA8B,cAAa;AAExD,yCAAyC;AACzC,OAAO,SAASC,gBACdC,OAAe,EACfC,SAAiB,EACjBC,YAA8B;IAE9B,IAAIC,SAASH;IACb,IAAII,WAAWH;IACf,IAAIG,SAASC,QAAQ,CAAC,WAAW;QAC/B,kEAAkE;QAClED,YAAY;QACZD,SAASG,WAAWH;IACtB,OAAO,IAAIC,SAASC,QAAQ,CAAC,SAAS;QACpC,kEAAkE;QAClED,YAAY;QACZD,SAASI,SAASJ;IACpB,OAAO,IAAIC,SAASC,QAAQ,CAAC,YAAY;QACvC,kEAAkE;QAClED,YAAY;QACZD,SAASK,YAAYL;IACvB;IACA,MAAMM,SAASX,MAAMK,QAAQ;QAC3B,GAAGD,YAAY;QACfE;IACF;IAEA,IAAI,CAACK,QAAQ;QACX,MAAM,IAAIC,MAAM,CAAC,gBAAgB,EAAEN,UAAU;IAC/C;IAEA,OAAOK;AACT;AAEA,SAASH,WAAWH,MAAc;IAChC,2DAA2D;IAC3D,wDAAwD;IACxD,MAAMQ,aAAaR,OAAOS,KAAK,CAAC;IAChC,IAAI,CAACD,YAAY;QACf,OAAO;IACT;IAEA,OAAOA,WACJE,GAAG,CAAC,CAACC;QACJ,6BAA6B;QAC7B,OAAOA,UAAUC,KAAK,CAAC,SAASC,KAAK,CAAC,GAAG,CAAC,GAAGC,IAAI,CAAC;IACpD,GACCA,IAAI,CAAC;AACV;AAEA,SAASV,SAASJ,MAAc;IAC9B,sEAAsE;IACtE,MAAMe,cAAc;IACpB,oDAAoD;IACpD,6CAA6C;IAC7C,MAAMC,UAAUC,iBAAiBjB,QAAQe;IACzC,IAAIC,QAAQE,MAAM,KAAK,GAAG;QACxB,OAAO;IACT;IAEA,OAAOF,QAAQN,GAAG,CAAC,CAACD,QAAUA,KAAK,CAAC,EAAE,EAAEK,IAAI,CAAC;AAC/C;AAEA,SAAST,YAAYL,MAAc;IACjC,sEAAsE;IACtE,MAAMe,cAAc;IACpB,oDAAoD;IACpD,6CAA6C;IAC7C,MAAMC,UAAUC,iBAAiBjB,QAAQe;IACzC,IAAIC,QAAQE,MAAM,KAAK,GAAG;QACxB,OAAO;IACT;IAEA,OAAOF,QAAQN,GAAG,CAAC,CAACD,QAAUA,KAAK,CAAC,EAAE,EAAEK,IAAI,CAAC;AAC/C;AAEA,+CAA+C;AAC/C,SAASG,iBAAiBE,GAAW,EAAEC,KAAa;IAClD,IAAI,CAACA,MAAMC,MAAM,EAAE;QACjB,MAAM,IAAId,MAAM;IAClB;IAEA,MAAMS,UAAU,EAAE;IAClB,IAAIP;IACJ,MAAO,AAACA,CAAAA,QAAQW,MAAME,IAAI,CAACH,IAAG,MAAO,KAAM;QACzCH,QAAQO,IAAI,CAACd;IACf;IACA,OAAOO;AACT"}