{"version":3,"sources":["../../../src/commands/typegen/generate.ts"],"sourcesContent":["import {stat} from 'node:fs/promises'\nimport {styleText} from 'node:util'\n\nimport {Flags} from '@oclif/core'\nimport {SanityCommand} from '@sanity/cli-core'\nimport {spinner} from '@sanity/cli-core/ux'\nimport {omit, once} from 'lodash-es'\n\nimport {runTypegenGenerate} from '../../actions/typegenGenerate.js'\nimport {runTypegenWatcher} from '../../actions/typegenWatch.js'\nimport {configDefinition, readConfig, type TypeGenConfig} from '../../readConfig.js'\nimport {TypegenWatchModeTrace, TypesGeneratedTrace} from '../../typegen.telemetry.js'\nimport {debug} from '../../utils/debug.js'\nimport {promiseWithResolvers} from '../../utils/promiseWithResolvers.js'\n\nconst description = `Sanity TypeGen\n\n${styleText('bold', 'Configuration:')}\nThis command can utilize configuration settings defined in a \\`sanity-typegen.json\\` file. These settings include:\n\n- \"path\": Specifies a glob pattern to locate your TypeScript or JavaScript files.\n  Default: \"./src/**/*.{ts,tsx,js,jsx}\"\n\n- \"schema\": Defines the path to your Sanity schema file. This file should be generated using the \\`sanity schema extract\\` command.\n  Default: \"schema.json\"\n\n- \"generates\": Indicates the path where the generated TypeScript type definitions will be saved.\n  Default: \"./sanity.types.ts\"\n\nThe default configuration values listed above are used if not overridden in your \\`sanity-typegen.json\\` configuration file. To customize the behavior of the type generation, adjust these properties in the configuration file according to your project's needs.\n\n${styleText('bold', 'Note:')}\n- The \\`sanity schema extract\\` command is a prerequisite for extracting your Sanity Studio schema into a \\`schema.json\\` file, which is then used by the \\`sanity typegen generate\\` command to generate type definitions.`.trim()\n\n/**\n * @internal\n */\nexport class TypegenGenerateCommand extends SanityCommand<typeof TypegenGenerateCommand> {\n  static override description = description\n\n  static override examples = [\n    {\n      command: '<%= config.bin %> <%= command.id %>',\n      description: `Generate TypeScript type definitions from a Sanity Studio schema extracted using the \\`sanity schema extract\\` command.`,\n    },\n  ]\n\n  static override flags = {\n    'config-path': Flags.string({\n      description:\n        '[Default: sanity-typegen.json] Specifies the path to the typegen configuration file. This file should be a JSON file that contains settings for the type generation process.',\n    }),\n    watch: Flags.boolean({\n      default: false,\n      description: '[Default: false] Run the typegen in watch mode',\n    }),\n  }\n\n  public async run() {\n    const {flags} = await this.parse(TypegenGenerateCommand)\n\n    if (flags.watch) {\n      await this.runWatcher()\n      return\n    }\n\n    await this.runSingle()\n  }\n\n  private async getConfig(): Promise<{\n    config: TypeGenConfig\n    path?: string\n    type: 'cli' | 'legacy'\n    workDir: string\n  }> {\n    const spin = spinner({}).start('Loading configâ€¦')\n\n    try {\n      const {flags} = await this.parse(TypegenGenerateCommand)\n      const rootDir = await this.getProjectRoot()\n      const config = await this.getCliConfig()\n\n      const configPath = flags['config-path']\n      const workDir = rootDir.directory\n\n      // check if the legacy config exist\n      const legacyConfigPath = configPath || 'sanity-typegen.json'\n      let hasLegacyConfig = false\n\n      try {\n        const file = await stat(legacyConfigPath)\n        hasLegacyConfig = file.isFile()\n      } catch (err) {\n        if (err instanceof Error && 'code' in err && err.code === 'ENOENT' && configPath) {\n          spin.fail()\n          this.error(`Typegen config file not found: ${configPath}`, {exit: 1})\n        }\n\n        if (err instanceof Error && 'code' in err && err.code !== 'ENOENT') {\n          spin.fail()\n          this.error(`Error when checking if typegen config file exists: ${legacyConfigPath}`, {\n            exit: 1,\n          })\n        }\n      }\n\n      // we have both legacy and cli config with typegen\n      if (config?.typegen && hasLegacyConfig) {\n        spin.warn(\n          styleText(\n            'yellow',\n            `You've specified typegen in your Sanity CLI config, but also have a typegen config.\n\n    The config from the Sanity CLI config is used.\n    `,\n          ),\n        )\n\n        return {\n          config: configDefinition.parse(config.typegen || {}),\n          path: rootDir.path,\n          type: 'cli',\n          workDir,\n        }\n      }\n\n      // we only have legacy typegen config\n      if (hasLegacyConfig) {\n        spin.warn(\n          styleText(\n            'yellow',\n            `The separate typegen config has been deprecated. Use \\`typegen\\` in the sanity CLI config instead.\n\n    See: https://www.sanity.io/docs/help/configuring-typegen-in-sanity-cli-config`,\n          ),\n        )\n        return {\n          config: await readConfig(legacyConfigPath),\n          path: legacyConfigPath,\n          type: 'legacy',\n          workDir,\n        }\n      }\n\n      spin.succeed(`Config loaded from sanity.cli.ts`)\n\n      // we only have cli config\n      return {\n        config: configDefinition.parse(config.typegen || {}),\n        path: rootDir.path,\n        type: 'cli',\n        workDir,\n      }\n    } catch (err) {\n      spin.fail()\n      this.error(`An error occured during config loading ${err}`, {exit: 1})\n    }\n  }\n\n  private async runSingle() {\n    const trace = this.telemetry.trace(TypesGeneratedTrace)\n\n    try {\n      const {config: typegenConfig, type: typegenConfigMethod, workDir} = await this.getConfig()\n      trace.start()\n\n      const result = await runTypegenGenerate({\n        config: typegenConfig,\n        workDir,\n      })\n\n      const traceStats = omit(result, 'code', 'duration')\n\n      trace.log({\n        configMethod: typegenConfigMethod,\n        configOverloadClientMethods: typegenConfig.overloadClientMethods,\n        ...traceStats,\n      })\n      trace.complete()\n    } catch (error) {\n      debug(error)\n      trace.error(error as Error)\n      this.error(`${error instanceof Error ? error.message : 'Unknown error'}`, {\n        exit: 1,\n      })\n    }\n  }\n\n  private async runWatcher() {\n    const trace = this.telemetry.trace(TypegenWatchModeTrace)\n\n    try {\n      const {config: typegenConfig, workDir} = await this.getConfig()\n      trace.start()\n\n      const {promise, resolve} = promiseWithResolvers()\n\n      const typegenWatcher = runTypegenWatcher({\n        config: typegenConfig,\n        workDir,\n      })\n\n      const stop = once(async () => {\n        process.off('SIGINT', stop)\n        process.off('SIGTERM', stop)\n\n        trace.log({\n          step: 'stopped',\n          ...typegenWatcher.getStats(),\n        })\n        trace.complete()\n\n        await typegenWatcher.stop()\n        resolve()\n      })\n\n      process.on('SIGINT', stop)\n      process.on('SIGTERM', stop)\n\n      await promise\n    } catch (error) {\n      debug(error)\n      trace.error(error as Error)\n      this.error(`${error instanceof Error ? error.message : 'Unknown error'}`, {\n        exit: 1,\n      })\n    }\n  }\n}\n"],"names":["stat","styleText","Flags","SanityCommand","spinner","omit","once","runTypegenGenerate","runTypegenWatcher","configDefinition","readConfig","TypegenWatchModeTrace","TypesGeneratedTrace","debug","promiseWithResolvers","description","trim","TypegenGenerateCommand","examples","command","flags","string","watch","boolean","default","run","parse","runWatcher","runSingle","getConfig","spin","start","rootDir","getProjectRoot","config","getCliConfig","configPath","workDir","directory","legacyConfigPath","hasLegacyConfig","file","isFile","err","Error","code","fail","error","exit","typegen","warn","path","type","succeed","trace","telemetry","typegenConfig","typegenConfigMethod","result","traceStats","log","configMethod","configOverloadClientMethods","overloadClientMethods","complete","message","promise","resolve","typegenWatcher","stop","process","off","step","getStats","on"],"mappings":"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"}