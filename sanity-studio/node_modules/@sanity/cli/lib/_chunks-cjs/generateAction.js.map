{"version":3,"file":"generateAction.js","sources":["../../../../../node_modules/.pnpm/lodash-es@4.17.23/node_modules/lodash-es/before.js","../../../../../node_modules/.pnpm/lodash-es@4.17.23/node_modules/lodash-es/once.js","../../src/util/promiseWithResolvers.ts","../../src/actions/typegen/generateAction.ts"],"sourcesContent":["import toInteger from './toInteger.js';\n\n/** Error message constants. */\nvar FUNC_ERROR_TEXT = 'Expected a function';\n\n/**\n * Creates a function that invokes `func`, with the `this` binding and arguments\n * of the created function, while it's called less than `n` times. Subsequent\n * calls to the created function return the result of the last `func` invocation.\n *\n * @static\n * @memberOf _\n * @since 3.0.0\n * @category Function\n * @param {number} n The number of calls at which `func` is no longer invoked.\n * @param {Function} func The function to restrict.\n * @returns {Function} Returns the new restricted function.\n * @example\n *\n * jQuery(element).on('click', _.before(5, addContactToList));\n * // => Allows adding up to 4 contacts to the list.\n */\nfunction before(n, func) {\n  var result;\n  if (typeof func != 'function') {\n    throw new TypeError(FUNC_ERROR_TEXT);\n  }\n  n = toInteger(n);\n  return function() {\n    if (--n > 0) {\n      result = func.apply(this, arguments);\n    }\n    if (n <= 1) {\n      func = undefined;\n    }\n    return result;\n  };\n}\n\nexport default before;\n","import before from './before.js';\n\n/**\n * Creates a function that is restricted to invoking `func` once. Repeat calls\n * to the function return the value of the first invocation. The `func` is\n * invoked with the `this` binding and arguments of the created function.\n *\n * @static\n * @memberOf _\n * @since 0.1.0\n * @category Function\n * @param {Function} func The function to restrict.\n * @returns {Function} Returns the new restricted function.\n * @example\n *\n * var initialize = _.once(createApplication);\n * initialize();\n * initialize();\n * // => `createApplication` is invoked once\n */\nfunction once(func) {\n  return before(2, func);\n}\n\nexport default once;\n","// TODO: replace with `Promise.withResolvers()` once it lands in node\nexport const promiseWithResolvers =\n  Promise.withResolvers?.bind(Promise) ||\n  function promiseWithResolvers<T>() {\n    let resolve!: (t: T) => void\n    let reject!: (err: unknown) => void\n    const promise = new Promise<T>((res, rej) => {\n      resolve = res\n      reject = rej\n    })\n    return {promise, resolve, reject}\n  }\n","import {stat} from 'node:fs/promises'\n\nimport {\n  configDefinition,\n  readConfig,\n  runTypegenGenerate,\n  runTypegenWatcher,\n  type TypeGenConfig,\n  TypegenWatchModeTrace,\n  TypesGeneratedTrace,\n} from '@sanity/codegen'\nimport chalk from 'chalk'\nimport {omit, once} from 'lodash-es'\n\nimport {type CliCommandArguments, type CliCommandContext} from '../../types'\nimport {getCliConfig} from '../../util/getCliConfig'\nimport {promiseWithResolvers} from '../../util/promiseWithResolvers'\n\nexport interface TypegenGenerateTypesCommandFlags {\n  'config-path'?: string\n  'watch'?: boolean\n}\n\nasync function getConfig(\n  workDir: string,\n  configPath?: string,\n): Promise<{config: TypeGenConfig; path?: string; type: 'legacy' | 'cli'}> {\n  const config = await getCliConfig(workDir)\n\n  if (!config?.config) {\n    throw new Error('Unable to load config')\n  }\n\n  // check if the legacy config exist\n  const legacyConfigPath = configPath || 'sanity-typegen.json'\n  let hasLegacyConfig = false\n  try {\n    const file = await stat(legacyConfigPath)\n    hasLegacyConfig = file.isFile()\n  } catch (err) {\n    if (err.code === 'ENOENT' && configPath) {\n      throw new Error(`Typegen config file not found: ${configPath}`, {cause: err})\n    }\n\n    if (err.code !== 'ENOENT') {\n      throw new Error(`Error when checking if typegen config file exists: ${legacyConfigPath}`, {\n        cause: err,\n      })\n    }\n  }\n\n  // we have both legacy and cli config with typegen\n  if (config?.config?.typegen && hasLegacyConfig) {\n    console.warn(\n      chalk.yellow(\n        `You've specified typegen in your Sanity CLI config, but also have a typegen config.\n\nThe config from the Sanity CLI config is used.\n`,\n      ),\n    )\n\n    return {\n      config: configDefinition.parse(config.config.typegen || {}),\n      path: config.path,\n      type: 'cli',\n    }\n  }\n\n  // we only have legacy typegen config\n  if (hasLegacyConfig) {\n    console.warn(\n      chalk.yellow(\n        `The separate typegen config has been deprecated. Use \\`typegen\\` in the sanity CLI config instead.\n\nSee: https://www.sanity.io/docs/help/configuring-typegen-in-sanity-cli-config`,\n      ),\n    )\n    return {\n      config: await readConfig(legacyConfigPath),\n      path: legacyConfigPath,\n      type: 'legacy',\n    }\n  }\n\n  // we only have cli config\n  return {\n    config: configDefinition.parse(config?.config?.typegen || {}),\n    path: config?.path,\n    type: 'cli',\n  }\n}\n\nasync function runSingle(\n  {extOptions: flags}: CliCommandArguments<TypegenGenerateTypesCommandFlags>,\n  context: CliCommandContext,\n) {\n  const {output, workDir, telemetry} = context\n\n  const trace = telemetry.trace(TypesGeneratedTrace)\n  trace.start()\n\n  const spinner = output.spinner({}).start('Loading config…')\n  try {\n    let config: Awaited<ReturnType<typeof getConfig>>\n    try {\n      config = await getConfig(workDir, flags['config-path'])\n      spinner.succeed(`Config loaded from ${config.path?.replace(workDir, '.')}`)\n    } catch (err) {\n      spinner.fail()\n      throw err\n    }\n\n    const {config: typegenConfig, type: typegenConfigMethod} = config\n\n    const result = await runTypegenGenerate({\n      config: typegenConfig,\n      workDir: context.workDir,\n    })\n    const traceStats = omit(result, 'code', 'duration')\n\n    trace.log({\n      ...traceStats,\n      configMethod: typegenConfigMethod,\n      configOverloadClientMethods: typegenConfig.overloadClientMethods,\n    })\n  } catch (error) {\n    console.error(` ${chalk.red('›')}   ${error.message}`)\n    trace.error(error as Error)\n    process.exitCode = 1\n    // throw error\n  } finally {\n    trace.complete()\n  }\n}\n\nasync function runWatcher(\n  {extOptions: flags}: CliCommandArguments<TypegenGenerateTypesCommandFlags>,\n  context: CliCommandContext,\n) {\n  const {output, workDir, telemetry} = context\n\n  const trace = telemetry.trace(TypegenWatchModeTrace)\n  trace.start()\n\n  const spinner = output.spinner({}).start('Loading config…')\n  try {\n    let config: Awaited<ReturnType<typeof getConfig>>\n    try {\n      config = await getConfig(workDir, flags['config-path'])\n      spinner.succeed(`Config loaded from ${config.path?.replace(workDir, '.')}`)\n    } catch (err) {\n      spinner.fail()\n      throw err\n    }\n\n    const typegenConfig = config.config\n    const {promise, resolve} = promiseWithResolvers<void>()\n\n    const typegenWatcher = runTypegenWatcher({\n      config: typegenConfig,\n      workDir,\n      spin: spinner,\n    })\n\n    const stop = once(async () => {\n      process.off('SIGINT', stop)\n      process.off('SIGTERM', stop)\n\n      trace.log({\n        step: 'stopped',\n        ...typegenWatcher.getStats(),\n      })\n\n      await typegenWatcher.stop()\n      resolve()\n    })\n\n    process.on('SIGINT', stop)\n    process.on('SIGTERM', stop)\n\n    await promise\n  } catch (error) {\n    console.error(` ${chalk.red('›')}   ${error.message}`)\n    trace.error(error as Error)\n    process.exitCode = 1\n  } finally {\n    trace.complete()\n  }\n}\n\nexport default async function typegenGenerateAction(\n  args: CliCommandArguments<TypegenGenerateTypesCommandFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const {extOptions: flags} = args\n\n  if (flags.watch) {\n    await runWatcher(args, context)\n    return\n  }\n\n  await runSingle(args, context)\n}\n"],"names":["toInteger","getCliConfig","stat","chalk","configDefinition","readConfig","TypesGeneratedTrace","runTypegenGenerate","omit","TypegenWatchModeTrace","runTypegenWatcher"],"mappings":"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","x_google_ignoreList":[0,1]}