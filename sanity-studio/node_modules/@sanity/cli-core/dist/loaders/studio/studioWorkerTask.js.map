{"version":3,"sources":["../../../src/loaders/studio/studioWorkerTask.ts"],"sourcesContent":["import {Worker, type WorkerOptions} from 'node:worker_threads'\n\nimport {type RequireProps} from '../../types.js'\nimport {isRecord} from '../../util/isRecord.js'\n\n/**\n * Options for the studio worker task\n *\n * @internal\n */\ninterface StudioWorkerTaskOptions extends RequireProps<WorkerOptions, 'name'> {\n  studioRootPath: string\n}\n\n/**\n * Executes a worker file in a Sanity Studio browser context.\n *\n * This uses a combination of vite for \"bundling\" + jsdom for emulating a browser\n * environment under the hood, which means that the same thing that will work in vite\n * _should_ work in the worker - to a degree. If the user has defined any typescript\n * path aliases, these will have to be added as aliases to the vite config - the same\n * behavior as you would see with regular vite. Other things that are accounted for:\n *\n * - TypeScript support (+JSX, enums and other \"compilation needed\" features)\n * - CSS, font and other file imports will resolve to a file path\n * - CSS module imports will resolve to a javascript object of class names\n * - Environment variables are available both as `import.meta.env` and `process.env`,\n *   and `.env` files are loaded in the same way that they would in a Sanity studio.\n * - Browser globals not available in a Node.js environment but _are_ provided by JSDOM\n *   are defined directly to the Node environment as globals. While this polutes the\n *   global namespace, it is done only in the worker thread.\n * - Certain browser globals that are _not_ available in JSDOM are also provided to the\n *   global namespace - things like `requestIdleCallback`, `IntersectionObserver` etc.\n *   These are provided with a minimal stub implementation to make them not crash.\n *\n * @param filePath - Path to the worker file (`.ts` works and is encouraged)\n * @param options - Options to pass to the worker\n * @returns A promise that resolves with the message from the worker\n * @throws If the file does not exist\n * @throws If the worker exits with a non-zero code\n * @internal\n */\nexport function studioWorkerTask<T = unknown>(\n  filePath: URL,\n  options: StudioWorkerTaskOptions,\n): Promise<T> {\n  return new Promise<T>((resolve, reject) => {\n    const worker = createStudioWorker(filePath, options)\n\n    worker.addListener('error', function onWorkerError(err) {\n      reject(new Error(`Fail to load file through worker: ${err.message}`))\n      cleanup()\n    })\n    worker.addListener('exit', function onWorkerExit(code) {\n      if (code > 0) {\n        reject(new Error(`Worker exited with code ${code}`))\n      }\n    })\n    worker.addListener('messageerror', function onWorkerMessageError(err) {\n      reject(new Error(`Fail to parse message from worker: ${err}`))\n      cleanup()\n    })\n    worker.addListener('message', function onWorkerMessage(message) {\n      resolve(message)\n      cleanup()\n    })\n\n    function cleanup() {\n      // Allow the worker a _bit_ of time to clean up, but ensure that we don't have\n      // lingering processes hanging around forever if the worker doesn't exit on its\n      // own.\n      setImmediate(() => worker.terminate())\n    }\n  })\n}\n\n/**\n * Creates a new worker for a studio worker task.\n *\n * This uses a combination of vite for \"bundling\" + jsdom for emulating a browser\n * environment under the hood, which means that the same thing that will work in vite\n * _should_ work in the worker - to a degree. If the user has defined any typescript\n * path aliases, these will have to be added as aliases to the vite config - the same\n * behavior as you would see with regular vite. Other things that are accounted for:\n *\n * - TypeScript support (+JSX, enums and other \"compilation needed\" features)\n * - CSS, font and other file imports will resolve to a file path\n * - CSS module imports will resolve to a javascript object of class names\n * - Environment variables are available both as `import.meta.env` and `process.env`,\n *   and `.env` files are loaded in the same way that they would in a Sanity studio.\n * - Browser globals not available in a Node.js environment but _are_ provided by JSDOM\n *   are defined directly to the Node environment as globals. While this polutes the\n *   global namespace, it is done only in the worker thread.\n * - Certain browser globals that are _not_ available in JSDOM are also provided to the\n *   global namespace - things like `requestIdleCallback`, `IntersectionObserver` etc.\n *   These are provided with a minimal stub implementation to make them not crash.\n *\n * @param filePath - Path to the worker file (`.ts` works and is encouraged)\n * @param options - Options to pass to the worker\n * @returns A promise that resolves with the message from the worker\n * @throws If the file does not exist\n * @throws If the worker exits with a non-zero code\n * @internal\n */\nexport function createStudioWorker(filePath: URL, options: StudioWorkerTaskOptions) {\n  if (!/\\.worker\\.(js|ts)$/.test(filePath.pathname)) {\n    throw new Error('Studio worker tasks must include `.worker.(js|ts)` in path')\n  }\n\n  return new Worker(new URL('studioWorkerLoader.worker.js', import.meta.url), {\n    ...options,\n    env: {\n      ...(isRecord(options.env) ? options.env : process.env),\n      STUDIO_WORKER_STUDIO_ROOT_PATH: options.studioRootPath,\n      STUDIO_WORKER_TASK_FILE: filePath.pathname,\n    },\n  })\n}\n"],"names":["Worker","isRecord","studioWorkerTask","filePath","options","Promise","resolve","reject","worker","createStudioWorker","addListener","onWorkerError","err","Error","message","cleanup","onWorkerExit","code","onWorkerMessageError","onWorkerMessage","setImmediate","terminate","test","pathname","URL","url","env","process","STUDIO_WORKER_STUDIO_ROOT_PATH","studioRootPath","STUDIO_WORKER_TASK_FILE"],"mappings":"AAAA,SAAQA,MAAM,QAA2B,sBAAqB;AAG9D,SAAQC,QAAQ,QAAO,yBAAwB;AAW/C;;;;;;;;;;;;;;;;;;;;;;;;;;;CA2BC,GACD,OAAO,SAASC,iBACdC,QAAa,EACbC,OAAgC;IAEhC,OAAO,IAAIC,QAAW,CAACC,SAASC;QAC9B,MAAMC,SAASC,mBAAmBN,UAAUC;QAE5CI,OAAOE,WAAW,CAAC,SAAS,SAASC,cAAcC,GAAG;YACpDL,OAAO,IAAIM,MAAM,CAAC,kCAAkC,EAAED,IAAIE,OAAO,EAAE;YACnEC;QACF;QACAP,OAAOE,WAAW,CAAC,QAAQ,SAASM,aAAaC,IAAI;YACnD,IAAIA,OAAO,GAAG;gBACZV,OAAO,IAAIM,MAAM,CAAC,wBAAwB,EAAEI,MAAM;YACpD;QACF;QACAT,OAAOE,WAAW,CAAC,gBAAgB,SAASQ,qBAAqBN,GAAG;YAClEL,OAAO,IAAIM,MAAM,CAAC,mCAAmC,EAAED,KAAK;YAC5DG;QACF;QACAP,OAAOE,WAAW,CAAC,WAAW,SAASS,gBAAgBL,OAAO;YAC5DR,QAAQQ;YACRC;QACF;QAEA,SAASA;YACP,8EAA8E;YAC9E,+EAA+E;YAC/E,OAAO;YACPK,aAAa,IAAMZ,OAAOa,SAAS;QACrC;IACF;AACF;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;CA2BC,GACD,OAAO,SAASZ,mBAAmBN,QAAa,EAAEC,OAAgC;IAChF,IAAI,CAAC,qBAAqBkB,IAAI,CAACnB,SAASoB,QAAQ,GAAG;QACjD,MAAM,IAAIV,MAAM;IAClB;IAEA,OAAO,IAAIb,OAAO,IAAIwB,IAAI,gCAAgC,YAAYC,GAAG,GAAG;QAC1E,GAAGrB,OAAO;QACVsB,KAAK;YACH,GAAIzB,SAASG,QAAQsB,GAAG,IAAItB,QAAQsB,GAAG,GAAGC,QAAQD,GAAG;YACrDE,gCAAgCxB,QAAQyB,cAAc;YACtDC,yBAAyB3B,SAASoB,QAAQ;QAC5C;IACF;AACF"}