{"version":3,"sources":["../../../src/config/studio/readStudioConfig.ts"],"sourcesContent":["import {dirname} from 'node:path'\n\nimport {z} from 'zod'\n\nimport {studioWorkerTask} from '../../loaders/studio/studioWorkerTask.js'\n\nconst schemaSchema = z.object({\n  name: z.string().optional(),\n  types: z.array(z.object({}).passthrough()),\n})\n\nconst sourceSchema = z.object({\n  dataset: z.string(),\n  projectId: z.string(),\n  schema: z.object({_original: schemaSchema}),\n})\n\nconst singleStudioWorkspaceSchema = z\n  .object({\n    ...sourceSchema.shape,\n    basePath: z.string().optional(),\n    name: z.string().optional(),\n    plugins: z.array(z.unknown()).optional(),\n    schema: schemaSchema.optional(),\n    title: z.string().optional(),\n    unstable_sources: z.array(sourceSchema),\n  })\n  .passthrough()\n\nconst studioWorkspaceSchema = z.object({\n  ...sourceSchema.shape,\n  basePath: z.string(),\n  name: z.string(),\n  plugins: z.array(z.unknown()).optional(),\n  title: z.string(),\n  unstable_sources: z.array(sourceSchema),\n})\n\nconst rawConfigSchema = z.union([z.array(studioWorkspaceSchema), singleStudioWorkspaceSchema])\nconst resolvedConfigSchema = z.array(studioWorkspaceSchema)\n\nexport type RawStudioConfig = z.infer<typeof rawConfigSchema>\nexport type ResolvedStudioConfig = z.infer<typeof resolvedConfigSchema>\n\nexport interface ReadStudioConfigOptions {\n  /**\n   * Whether or not to resolve the plugins defined in the config.\n   *\n   * In some cases, you need this in order to have the full picture of what the studio\n   * would \"see\". As an example, plugins can define schema types that are not explicitly\n   * defined in the users' schema types. In order to get the full picture, you need to\n   * resolve the plugins, which is an asyncronous operation.\n   *\n   * In other cases, it might be enough to only do a shallow pass. As an example, if you\n   * only need to know about the defined workspace, or the user-defined schema types,\n   * this can be set to `false` - which should resolve faster (and potentially \"safer\")\n   * in terms of not triggering all kinds of browser behavior that may or may not be\n   * loaded as the plugins are resolved.\n   */\n  resolvePlugins: boolean\n}\n\nexport async function readStudioConfig(\n  configPath: string,\n  options: {resolvePlugins: true},\n): Promise<ResolvedStudioConfig>\n\nexport async function readStudioConfig(\n  configPath: string,\n  options: {resolvePlugins: false},\n): Promise<RawStudioConfig>\n\nexport async function readStudioConfig(\n  configPath: string,\n  options: ReadStudioConfigOptions,\n): Promise<RawStudioConfig | ResolvedStudioConfig> {\n  const result = await studioWorkerTask(new URL('readStudioConfig.worker.js', import.meta.url), {\n    name: 'studioConfig',\n    studioRootPath: dirname(configPath),\n    workerData: {configPath, resolvePlugins: options.resolvePlugins},\n  })\n\n  return options.resolvePlugins ? resolvedConfigSchema.parse(result) : rawConfigSchema.parse(result)\n}\n"],"names":["dirname","z","studioWorkerTask","schemaSchema","object","name","string","optional","types","array","passthrough","sourceSchema","dataset","projectId","schema","_original","singleStudioWorkspaceSchema","shape","basePath","plugins","unknown","title","unstable_sources","studioWorkspaceSchema","rawConfigSchema","union","resolvedConfigSchema","readStudioConfig","configPath","options","result","URL","url","studioRootPath","workerData","resolvePlugins","parse"],"mappings":"AAAA,SAAQA,OAAO,QAAO,YAAW;AAEjC,SAAQC,CAAC,QAAO,MAAK;AAErB,SAAQC,gBAAgB,QAAO,2CAA0C;AAEzE,MAAMC,eAAeF,EAAEG,MAAM,CAAC;IAC5BC,MAAMJ,EAAEK,MAAM,GAAGC,QAAQ;IACzBC,OAAOP,EAAEQ,KAAK,CAACR,EAAEG,MAAM,CAAC,CAAC,GAAGM,WAAW;AACzC;AAEA,MAAMC,eAAeV,EAAEG,MAAM,CAAC;IAC5BQ,SAASX,EAAEK,MAAM;IACjBO,WAAWZ,EAAEK,MAAM;IACnBQ,QAAQb,EAAEG,MAAM,CAAC;QAACW,WAAWZ;IAAY;AAC3C;AAEA,MAAMa,8BAA8Bf,EACjCG,MAAM,CAAC;IACN,GAAGO,aAAaM,KAAK;IACrBC,UAAUjB,EAAEK,MAAM,GAAGC,QAAQ;IAC7BF,MAAMJ,EAAEK,MAAM,GAAGC,QAAQ;IACzBY,SAASlB,EAAEQ,KAAK,CAACR,EAAEmB,OAAO,IAAIb,QAAQ;IACtCO,QAAQX,aAAaI,QAAQ;IAC7Bc,OAAOpB,EAAEK,MAAM,GAAGC,QAAQ;IAC1Be,kBAAkBrB,EAAEQ,KAAK,CAACE;AAC5B,GACCD,WAAW;AAEd,MAAMa,wBAAwBtB,EAAEG,MAAM,CAAC;IACrC,GAAGO,aAAaM,KAAK;IACrBC,UAAUjB,EAAEK,MAAM;IAClBD,MAAMJ,EAAEK,MAAM;IACda,SAASlB,EAAEQ,KAAK,CAACR,EAAEmB,OAAO,IAAIb,QAAQ;IACtCc,OAAOpB,EAAEK,MAAM;IACfgB,kBAAkBrB,EAAEQ,KAAK,CAACE;AAC5B;AAEA,MAAMa,kBAAkBvB,EAAEwB,KAAK,CAAC;IAACxB,EAAEQ,KAAK,CAACc;IAAwBP;CAA4B;AAC7F,MAAMU,uBAAuBzB,EAAEQ,KAAK,CAACc;AAiCrC,OAAO,eAAeI,iBACpBC,UAAkB,EAClBC,OAAgC;IAEhC,MAAMC,SAAS,MAAM5B,iBAAiB,IAAI6B,IAAI,8BAA8B,YAAYC,GAAG,GAAG;QAC5F3B,MAAM;QACN4B,gBAAgBjC,QAAQ4B;QACxBM,YAAY;YAACN;YAAYO,gBAAgBN,QAAQM,cAAc;QAAA;IACjE;IAEA,OAAON,QAAQM,cAAc,GAAGT,qBAAqBU,KAAK,CAACN,UAAUN,gBAAgBY,KAAK,CAACN;AAC7F"}