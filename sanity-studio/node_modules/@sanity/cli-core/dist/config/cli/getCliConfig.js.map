{"version":3,"sources":["../../../src/config/cli/getCliConfig.ts"],"sourcesContent":["import {pathToFileURL} from 'node:url'\n\nimport {getTsconfig} from 'get-tsconfig'\nimport {tsImport} from 'tsx/esm/api'\n\nimport {debug} from '../../debug.js'\nimport {tsxWorkerTask} from '../../loaders/tsx/tsxWorkerTask.js'\nimport {NotFoundError} from '../../util/NotFoundError.js'\nimport {tryGetDefaultExport} from '../../util/tryGetDefaultExport.js'\nimport {findPathForFiles} from '../util/findConfigsPaths.js'\nimport {cliConfigSchema} from './schemas.js'\nimport {type CliConfig} from './types/cliConfig.js'\n\n/**\n * Get the CLI config for a project, given the root path.\n *\n * We really want to avoid loading the CLI config in the main thread, as we'll need\n * TypeScript loading logic, potentially with ts path aliases, syntax extensions and all\n * sorts of nonsense. Thus, we _attempt_ to use a worker thread - but have to fall back\n * to using the main thread if not possible. This can be the case if the configuration\n * contains non-serializable properties, such as functions. This is unfortunately used\n * by the vite config, for example.\n *\n * @param rootPath - Root path for the project, eg where `sanity.cli.(ts|js)` is located.\n * @returns The CLI config\n * @internal\n */\nexport async function getCliConfig(rootPath: string): Promise<CliConfig> {\n  const paths = await findPathForFiles(rootPath, ['sanity.cli.ts', 'sanity.cli.js'])\n  const configPaths = paths.filter((path) => path.exists)\n\n  if (configPaths.length === 0) {\n    throw new NotFoundError(`No CLI config found at ${rootPath}/sanity.cli.(ts|js)`)\n  }\n\n  if (configPaths.length > 1) {\n    throw new Error(\n      `Multiple CLI config files found (${configPaths.map((path) => path.path).join(', ')})`,\n    )\n  }\n\n  const configPath = configPaths[0].path\n\n  let cliConfig: CliConfig | undefined\n  try {\n    cliConfig = await tsxWorkerTask<CliConfig | undefined>(\n      new URL('getCliConfig.worker.js', import.meta.url),\n      {\n        name: 'cliConfig',\n        rootPath,\n        workerData: {configPath},\n      },\n    )\n  } catch (err) {\n    debug('Failed to load CLI config in worker thread: %s', err)\n\n    // Assuming that didn't work because of unseriazable properties, so we'll try the\n    // main thread with tsx registered.\n    const tsconfig = getTsconfig(rootPath)\n\n    // Ensure we get the default export (sometimes we get a bit of a mixed bag)\n    cliConfig = await tsImport(pathToFileURL(configPath).href, {\n      parentURL: import.meta.url,\n      tsconfig: tsconfig?.path ?? undefined,\n    })\n    cliConfig = tryGetDefaultExport(cliConfig) as CliConfig | undefined\n\n    if (!cliConfig) {\n      throw new Error('Invalid CLI config structure')\n    }\n  }\n\n  const {data, error, success} = cliConfigSchema.safeParse(cliConfig)\n  if (!success) {\n    throw new Error(`Invalid CLI config: ${error.message}`)\n  }\n\n  // There is a minor difference here because of the `vite` property and how the types\n  // aren't as specific as our manually typed `CliConfig` type, thus the cast.\n  return data as CliConfig\n}\n"],"names":["pathToFileURL","getTsconfig","tsImport","debug","tsxWorkerTask","NotFoundError","tryGetDefaultExport","findPathForFiles","cliConfigSchema","getCliConfig","rootPath","paths","configPaths","filter","path","exists","length","Error","map","join","configPath","cliConfig","URL","url","name","workerData","err","tsconfig","href","parentURL","undefined","data","error","success","safeParse","message"],"mappings":"AAAA,SAAQA,aAAa,QAAO,WAAU;AAEtC,SAAQC,WAAW,QAAO,eAAc;AACxC,SAAQC,QAAQ,QAAO,cAAa;AAEpC,SAAQC,KAAK,QAAO,iBAAgB;AACpC,SAAQC,aAAa,QAAO,qCAAoC;AAChE,SAAQC,aAAa,QAAO,8BAA6B;AACzD,SAAQC,mBAAmB,QAAO,oCAAmC;AACrE,SAAQC,gBAAgB,QAAO,8BAA6B;AAC5D,SAAQC,eAAe,QAAO,eAAc;AAG5C;;;;;;;;;;;;;CAaC,GACD,OAAO,eAAeC,aAAaC,QAAgB;IACjD,MAAMC,QAAQ,MAAMJ,iBAAiBG,UAAU;QAAC;QAAiB;KAAgB;IACjF,MAAME,cAAcD,MAAME,MAAM,CAAC,CAACC,OAASA,KAAKC,MAAM;IAEtD,IAAIH,YAAYI,MAAM,KAAK,GAAG;QAC5B,MAAM,IAAIX,cAAc,CAAC,uBAAuB,EAAEK,SAAS,mBAAmB,CAAC;IACjF;IAEA,IAAIE,YAAYI,MAAM,GAAG,GAAG;QAC1B,MAAM,IAAIC,MACR,CAAC,iCAAiC,EAAEL,YAAYM,GAAG,CAAC,CAACJ,OAASA,KAAKA,IAAI,EAAEK,IAAI,CAAC,MAAM,CAAC,CAAC;IAE1F;IAEA,MAAMC,aAAaR,WAAW,CAAC,EAAE,CAACE,IAAI;IAEtC,IAAIO;IACJ,IAAI;QACFA,YAAY,MAAMjB,cAChB,IAAIkB,IAAI,0BAA0B,YAAYC,GAAG,GACjD;YACEC,MAAM;YACNd;YACAe,YAAY;gBAACL;YAAU;QACzB;IAEJ,EAAE,OAAOM,KAAK;QACZvB,MAAM,kDAAkDuB;QAExD,iFAAiF;QACjF,mCAAmC;QACnC,MAAMC,WAAW1B,YAAYS;QAE7B,2EAA2E;QAC3EW,YAAY,MAAMnB,SAASF,cAAcoB,YAAYQ,IAAI,EAAE;YACzDC,WAAW,YAAYN,GAAG;YAC1BI,UAAUA,UAAUb,QAAQgB;QAC9B;QACAT,YAAYf,oBAAoBe;QAEhC,IAAI,CAACA,WAAW;YACd,MAAM,IAAIJ,MAAM;QAClB;IACF;IAEA,MAAM,EAACc,IAAI,EAAEC,KAAK,EAAEC,OAAO,EAAC,GAAGzB,gBAAgB0B,SAAS,CAACb;IACzD,IAAI,CAACY,SAAS;QACZ,MAAM,IAAIhB,MAAM,CAAC,oBAAoB,EAAEe,MAAMG,OAAO,EAAE;IACxD;IAEA,oFAAoF;IACpF,4EAA4E;IAC5E,OAAOJ;AACT"}