{"version":3,"sources":["../../src/util/readPackageJson.ts"],"sourcesContent":["import {readFile} from 'node:fs/promises'\n\nimport {z} from 'zod'\n\n/**\n * Comprehensive package.json schema including all common properties.\n * Feel free to add properties to this,\n * üü†‚ÑπÔ∏è   BUT ENSURE OPTIONAL STUFF IS ACTUALLY OPTIONAL  ‚ÑπÔ∏èüü†\n * üü†‚ÑπÔ∏è SINCE THIS IS USED IN A NUMBER OF LOCATIONS WHERE ‚ÑπÔ∏èüü†\n * üü†‚ÑπÔ∏è WE CANNOT ENFORCE/GUARANTEE ANY PARTICULAR PROPS  ‚ÑπÔ∏èüü†\n */\nconst packageJsonSchema = z.looseObject({\n  // Required fields\n  name: z.string(),\n  version: z.string(),\n\n  // Dependencies (optional)\n  dependencies: z.record(z.string(), z.string()).optional(),\n  devDependencies: z.record(z.string(), z.string()).optional(),\n  peerDependencies: z.record(z.string(), z.string()).optional(),\n\n  // Module structure (optional)\n  exports: z.record(z.string(), z.any()).optional(),\n  main: z.string().optional(),\n  types: z.string().optional(),\n\n  // Metadata (optional)\n  author: z.string().optional(),\n  description: z.string().optional(),\n  engines: z.record(z.string(), z.string()).optional(),\n  license: z.string().optional(),\n  private: z.boolean().optional(),\n  repository: z\n    .object({\n      type: z.string(),\n      url: z.string(),\n    })\n    .optional(),\n  scripts: z.record(z.string(), z.string()).optional(),\n})\n\n/**\n * Comprehensive representation of a package.json file.\n * Consolidates all properties from previous type definitions.\n *\n * @public\n */\nexport type PackageJson = z.infer<typeof packageJsonSchema>\n\n/**\n * Options for reading package.json files\n *\n * @public\n */\nexport interface ReadPackageJsonOptions {\n  /**\n   * Default values to merge with the parsed package.json.\n   * Parsed values take precedence over defaults.\n   */\n  defaults?: Partial<PackageJson>\n\n  /**\n   * Skip Zod schema validation. When true, the file is parsed but not validated.\n   * Defaults to false.\n   */\n  skipSchemaValidation?: boolean\n}\n\n/**\n * Read the `package.json` file at the given path\n *\n * @param filePath - Path to package.json to read\n * @param options - Options object for controlling read behavior\n * @returns The parsed package.json\n * @public\n */\nexport async function readPackageJson(\n  filePath: string | URL,\n  options: ReadPackageJsonOptions = {},\n): Promise<PackageJson> {\n  const {defaults = {}, skipSchemaValidation = false} = options\n\n  // Read and parse the file\n  let pkg: Record<string, unknown>\n  try {\n    pkg = JSON.parse(await readFile(filePath, 'utf8'))\n  } catch (err: unknown) {\n    throw new Error(`Failed to read \"${filePath}\"`, {cause: err})\n  }\n\n  // Merge with defaults (parsed values take precedence)\n  const merged = {...defaults, ...pkg}\n\n  // Validate with schema unless skipped\n  let validated: PackageJson\n  if (skipSchemaValidation) {\n    validated = merged as PackageJson\n  } else {\n    const {data, error, success} = packageJsonSchema.safeParse(merged)\n    if (!success) {\n      throw new Error(\n        `Invalid package.json at \"${filePath}\": ${error.issues.map((err) => err.message).join('\\n')}`,\n      )\n    }\n    validated = data\n  }\n\n  return validated\n}\n"],"names":["readFile","z","packageJsonSchema","looseObject","name","string","version","dependencies","record","optional","devDependencies","peerDependencies","exports","any","main","types","author","description","engines","license","private","boolean","repository","object","type","url","scripts","readPackageJson","filePath","options","defaults","skipSchemaValidation","pkg","JSON","parse","err","Error","cause","merged","validated","data","error","success","safeParse","issues","map","message","join"],"mappings":"AAAA,SAAQA,QAAQ,QAAO,mBAAkB;AAEzC,SAAQC,CAAC,QAAO,MAAK;AAErB;;;;;;CAMC,GACD,MAAMC,oBAAoBD,EAAEE,WAAW,CAAC;IACtC,kBAAkB;IAClBC,MAAMH,EAAEI,MAAM;IACdC,SAASL,EAAEI,MAAM;IAEjB,0BAA0B;IAC1BE,cAAcN,EAAEO,MAAM,CAACP,EAAEI,MAAM,IAAIJ,EAAEI,MAAM,IAAII,QAAQ;IACvDC,iBAAiBT,EAAEO,MAAM,CAACP,EAAEI,MAAM,IAAIJ,EAAEI,MAAM,IAAII,QAAQ;IAC1DE,kBAAkBV,EAAEO,MAAM,CAACP,EAAEI,MAAM,IAAIJ,EAAEI,MAAM,IAAII,QAAQ;IAE3D,8BAA8B;IAC9BG,SAASX,EAAEO,MAAM,CAACP,EAAEI,MAAM,IAAIJ,EAAEY,GAAG,IAAIJ,QAAQ;IAC/CK,MAAMb,EAAEI,MAAM,GAAGI,QAAQ;IACzBM,OAAOd,EAAEI,MAAM,GAAGI,QAAQ;IAE1B,sBAAsB;IACtBO,QAAQf,EAAEI,MAAM,GAAGI,QAAQ;IAC3BQ,aAAahB,EAAEI,MAAM,GAAGI,QAAQ;IAChCS,SAASjB,EAAEO,MAAM,CAACP,EAAEI,MAAM,IAAIJ,EAAEI,MAAM,IAAII,QAAQ;IAClDU,SAASlB,EAAEI,MAAM,GAAGI,QAAQ;IAC5BW,SAASnB,EAAEoB,OAAO,GAAGZ,QAAQ;IAC7Ba,YAAYrB,EACTsB,MAAM,CAAC;QACNC,MAAMvB,EAAEI,MAAM;QACdoB,KAAKxB,EAAEI,MAAM;IACf,GACCI,QAAQ;IACXiB,SAASzB,EAAEO,MAAM,CAACP,EAAEI,MAAM,IAAIJ,EAAEI,MAAM,IAAII,QAAQ;AACpD;AA6BA;;;;;;;CAOC,GACD,OAAO,eAAekB,gBACpBC,QAAsB,EACtBC,UAAkC,CAAC,CAAC;IAEpC,MAAM,EAACC,WAAW,CAAC,CAAC,EAAEC,uBAAuB,KAAK,EAAC,GAAGF;IAEtD,0BAA0B;IAC1B,IAAIG;IACJ,IAAI;QACFA,MAAMC,KAAKC,KAAK,CAAC,MAAMlC,SAAS4B,UAAU;IAC5C,EAAE,OAAOO,KAAc;QACrB,MAAM,IAAIC,MAAM,CAAC,gBAAgB,EAAER,SAAS,CAAC,CAAC,EAAE;YAACS,OAAOF;QAAG;IAC7D;IAEA,sDAAsD;IACtD,MAAMG,SAAS;QAAC,GAAGR,QAAQ;QAAE,GAAGE,GAAG;IAAA;IAEnC,sCAAsC;IACtC,IAAIO;IACJ,IAAIR,sBAAsB;QACxBQ,YAAYD;IACd,OAAO;QACL,MAAM,EAACE,IAAI,EAAEC,KAAK,EAAEC,OAAO,EAAC,GAAGxC,kBAAkByC,SAAS,CAACL;QAC3D,IAAI,CAACI,SAAS;YACZ,MAAM,IAAIN,MACR,CAAC,yBAAyB,EAAER,SAAS,GAAG,EAAEa,MAAMG,MAAM,CAACC,GAAG,CAAC,CAACV,MAAQA,IAAIW,OAAO,EAAEC,IAAI,CAAC,OAAO;QAEjG;QACAR,YAAYC;IACd;IAEA,OAAOD;AACT"}