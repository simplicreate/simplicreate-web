{"version":3,"sources":["../../src/telemetry/logger.ts"],"sourcesContent":["import {\n  type DefinedTelemetryLog,\n  type DefinedTelemetryTrace,\n  type TelemetryEvent,\n  type TelemetryLogger,\n  type TelemetryTrace,\n} from '@sanity/telemetry'\n\nimport {telemetryStoreDebug} from './telemetryStoreDebug.js'\nimport {createTrace} from './trace.js'\n\n// Sample rate tracking for log events\nconst logSampleTracker = new Map<string, number>()\n\n/**\n * Creates a telemetry logger that emits events via the provided emit function\n * @internal\n */\nexport function createLogger<UserProperties>(\n  sessionId: string,\n  emit: (event: TelemetryEvent) => void,\n): TelemetryLogger<UserProperties> {\n  telemetryStoreDebug('Creating logger for session: %s', sessionId)\n\n  const log = <Data>(event: DefinedTelemetryLog<Data>, data?: Data) => {\n    telemetryStoreDebug('Logging event: %s', event.name)\n\n    // Handle sampling if maxSampleRate is specified\n    if (event.maxSampleRate && event.maxSampleRate > 0) {\n      const now = Date.now()\n      const lastEmit = logSampleTracker.get(event.name) || 0\n\n      if (now - lastEmit < event.maxSampleRate) {\n        telemetryStoreDebug(\n          'Skipping event %s due to sampling (maxSampleRate: %d)',\n          event.name,\n          event.maxSampleRate,\n        )\n        return // Skip due to sampling\n      }\n\n      logSampleTracker.set(event.name, now)\n      telemetryStoreDebug('Event %s passed sampling check', event.name)\n    }\n\n    const logEvent: TelemetryEvent = {\n      createdAt: new Date().toISOString(),\n      data: data ?? null,\n      name: event.name,\n      sessionId,\n      type: 'log',\n      version: event.version,\n    }\n\n    emit(logEvent)\n  }\n\n  const trace = <Data, Context = unknown>(\n    event: DefinedTelemetryTrace<Data, Context>,\n    context?: Context,\n  ): TelemetryTrace<UserProperties, Data> => {\n    telemetryStoreDebug('Creating trace: %s', event.name)\n    return createTrace(event, context, sessionId, emit, createLogger)\n  }\n\n  const updateUserProperties = (properties: UserProperties) => {\n    telemetryStoreDebug('Updating user properties: %o', properties)\n    const userPropsEvent: TelemetryEvent = {\n      createdAt: new Date().toISOString(),\n      properties,\n      sessionId,\n      type: 'userProperties',\n    }\n\n    emit(userPropsEvent)\n  }\n\n  return {\n    log,\n    trace,\n    updateUserProperties,\n  }\n}\n"],"names":["telemetryStoreDebug","createTrace","logSampleTracker","Map","createLogger","sessionId","emit","log","event","data","name","maxSampleRate","now","Date","lastEmit","get","set","logEvent","createdAt","toISOString","type","version","trace","context","updateUserProperties","properties","userPropsEvent"],"mappings":"AAQA,SAAQA,mBAAmB,QAAO,2BAA0B;AAC5D,SAAQC,WAAW,QAAO,aAAY;AAEtC,sCAAsC;AACtC,MAAMC,mBAAmB,IAAIC;AAE7B;;;CAGC,GACD,OAAO,SAASC,aACdC,SAAiB,EACjBC,IAAqC;IAErCN,oBAAoB,mCAAmCK;IAEvD,MAAME,MAAM,CAAOC,OAAkCC;QACnDT,oBAAoB,qBAAqBQ,MAAME,IAAI;QAEnD,gDAAgD;QAChD,IAAIF,MAAMG,aAAa,IAAIH,MAAMG,aAAa,GAAG,GAAG;YAClD,MAAMC,MAAMC,KAAKD,GAAG;YACpB,MAAME,WAAWZ,iBAAiBa,GAAG,CAACP,MAAME,IAAI,KAAK;YAErD,IAAIE,MAAME,WAAWN,MAAMG,aAAa,EAAE;gBACxCX,oBACE,yDACAQ,MAAME,IAAI,EACVF,MAAMG,aAAa;gBAErB,QAAO,uBAAuB;YAChC;YAEAT,iBAAiBc,GAAG,CAACR,MAAME,IAAI,EAAEE;YACjCZ,oBAAoB,kCAAkCQ,MAAME,IAAI;QAClE;QAEA,MAAMO,WAA2B;YAC/BC,WAAW,IAAIL,OAAOM,WAAW;YACjCV,MAAMA,QAAQ;YACdC,MAAMF,MAAME,IAAI;YAChBL;YACAe,MAAM;YACNC,SAASb,MAAMa,OAAO;QACxB;QAEAf,KAAKW;IACP;IAEA,MAAMK,QAAQ,CACZd,OACAe;QAEAvB,oBAAoB,sBAAsBQ,MAAME,IAAI;QACpD,OAAOT,YAAYO,OAAOe,SAASlB,WAAWC,MAAMF;IACtD;IAEA,MAAMoB,uBAAuB,CAACC;QAC5BzB,oBAAoB,gCAAgCyB;QACpD,MAAMC,iBAAiC;YACrCR,WAAW,IAAIL,OAAOM,WAAW;YACjCM;YACApB;YACAe,MAAM;QACR;QAEAd,KAAKoB;IACP;IAEA,OAAO;QACLnB;QACAe;QACAE;IACF;AACF"}