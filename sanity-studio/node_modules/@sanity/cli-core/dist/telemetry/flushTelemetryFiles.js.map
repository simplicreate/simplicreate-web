{"version":3,"sources":["../../src/telemetry/flushTelemetryFiles.ts"],"sourcesContent":["import {rm} from 'node:fs/promises'\n\nimport {type TelemetryEvent} from '@sanity/telemetry'\nimport {catchError, defer, from, lastValueFrom, mergeMap, of, reduce, switchMap, tap} from 'rxjs'\n\nimport {readNDJSON} from '../util/readNDJSON.js'\nimport {cleanupOldTelemetryFiles} from './cleanupOldTelemetryFiles.js'\nimport {findTelemetryFiles} from './findTelemetryFiles.js'\nimport {telemetryStoreDebug} from './telemetryStoreDebug.js'\nimport {type ConsentInformation} from './types.js'\n\ninterface FlushTelemetryFilesOptions {\n  resolveConsent: () => Promise<ConsentInformation>\n  sendEvents: (events: TelemetryEvent[]) => Promise<void>\n}\n\n/**\n * Standalone, stateless function to flush telemetry files.\n *\n * This function can be used independently of the telemetry store, making it\n * suitable for use in child processes or other contexts where store state\n * is not available.\n *\n * @param options - Configuration for consent resolution and event sending\n * @returns Promise that resolves when flush operation is complete\n *\n * @internal\n */\nexport async function flushTelemetryFiles(options: FlushTelemetryFilesOptions): Promise<void> {\n  telemetryStoreDebug('Starting standalone flush operation')\n\n  // Helper function for deleting files with consistent error handling\n  const deleteFiles = (files: string[], reason: string) => {\n    if (files.length === 0) {\n      // of() is not same as of(undefined) in rxjs\n      // eslint-disable-next-line unicorn/no-useless-undefined\n      return of(undefined)\n    }\n\n    return from(files).pipe(\n      mergeMap((filePath) =>\n        from(rm(filePath, {force: true})).pipe(\n          tap(() => {\n            telemetryStoreDebug(`Deleted file ${reason}: %s`, filePath)\n          }),\n          catchError((error) => {\n            telemetryStoreDebug('Error deleting file %s: %o', filePath, error)\n            // of() is not same as of(undefined) in rxjs\n            // eslint-disable-next-line unicorn/no-useless-undefined\n            return of(undefined)\n          }),\n        ),\n      ),\n      // of() is not same as of(undefined) in rxjs\n      // eslint-disable-next-line unicorn/no-useless-undefined\n      switchMap(() => of(undefined)),\n    )\n  }\n\n  const flush$ = defer(() => from(options.resolveConsent())).pipe(\n    tap((currentConsent) => {\n      telemetryStoreDebug('Current consent status for flush: %s', currentConsent.status)\n    }),\n    switchMap((currentConsent) => {\n      // First cleanup old files, then process current files\n      return defer(() => from(cleanupOldTelemetryFiles())).pipe(\n        switchMap(() => defer(() => from(findTelemetryFiles()))),\n        switchMap((filePaths) => {\n          if (filePaths.length === 0) {\n            telemetryStoreDebug('No telemetry files found, nothing to flush')\n            return of({allEvents: [], consent: currentConsent, filesToDelete: []})\n          }\n\n          telemetryStoreDebug('Found %d telemetry files to process', filePaths.length)\n\n          return from(filePaths).pipe(\n            mergeMap((filePath) => {\n              return defer(() => from(readNDJSON<TelemetryEvent>(filePath))).pipe(\n                tap((events) => {\n                  telemetryStoreDebug('Read %d events from %s', events.length, filePath)\n                }),\n                catchError((error) => {\n                  if ((error as {code?: string}).code === 'ENOENT') {\n                    telemetryStoreDebug('File %s no longer exists, skipping', filePath)\n                    return of([])\n                  }\n                  telemetryStoreDebug('Error reading file %s: %o', filePath, error)\n                  return of([])\n                }),\n                switchMap((events) => of({events, filePath: events.length > 0 ? filePath : ''})),\n              )\n            }),\n            reduce(\n              (acc: {allEvents: TelemetryEvent[]; filesToDelete: string[]}, current) => {\n                if (current.filePath) {\n                  acc.allEvents.push(...current.events)\n                  acc.filesToDelete.push(current.filePath)\n                }\n                return acc\n              },\n              {allEvents: [], filesToDelete: []},\n            ),\n            switchMap((result) => of({...result, consent: currentConsent})),\n          )\n        }),\n      )\n    }),\n    switchMap(({allEvents, consent, filesToDelete}) => {\n      telemetryStoreDebug(\n        'Found %d total events to flush from %d files',\n        allEvents.length,\n        filesToDelete.length,\n      )\n\n      if (consent.status !== 'granted' || allEvents.length === 0) {\n        if (consent.status === 'granted') {\n          telemetryStoreDebug('No events to send, cleaning up empty files')\n          return deleteFiles(filesToDelete, 'empty files')\n        } else {\n          telemetryStoreDebug(\n            'Consent not granted (%s), cleaning up %d files without sending events',\n            consent.status,\n            filesToDelete.length,\n          )\n          return deleteFiles(filesToDelete, `without sending (consent: ${consent.status})`)\n        }\n      }\n\n      // Send events and then delete files\n      telemetryStoreDebug('Sending %d events to backend', allEvents.length)\n\n      return defer(() => from(options.sendEvents(allEvents))).pipe(\n        tap(() => {\n          telemetryStoreDebug('Successfully sent events, deleting %d files', filesToDelete.length)\n        }),\n        switchMap(() => deleteFiles(filesToDelete, 'after successful send')),\n      )\n    }),\n    tap(() => {\n      telemetryStoreDebug('Standalone flush operation completed successfully')\n    }),\n    switchMap(() => of(undefined as void)),\n    catchError((error) => {\n      telemetryStoreDebug('Error during standalone flush operation: %o', error)\n      throw error\n    }),\n  )\n\n  return lastValueFrom(flush$)\n}\n"],"names":["rm","catchError","defer","from","lastValueFrom","mergeMap","of","reduce","switchMap","tap","readNDJSON","cleanupOldTelemetryFiles","findTelemetryFiles","telemetryStoreDebug","flushTelemetryFiles","options","deleteFiles","files","reason","length","undefined","pipe","filePath","force","error","flush$","resolveConsent","currentConsent","status","filePaths","allEvents","consent","filesToDelete","events","code","acc","current","push","result","sendEvents"],"mappings":"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"}