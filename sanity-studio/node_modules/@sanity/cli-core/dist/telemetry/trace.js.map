{"version":3,"sources":["../../src/telemetry/trace.ts"],"sourcesContent":["import {\n  type DefinedTelemetryTrace,\n  type TelemetryEvent,\n  type TelemetryLogger,\n  type TelemetryTrace,\n} from '@sanity/telemetry'\n\nimport {createTraceId} from './createTraceId.js'\nimport {telemetryStoreDebug} from './telemetryStoreDebug.js'\n\n/**\n * Creates a trace instance that can emit trace lifecycle events\n * @internal\n */\nexport function createTrace<Data, Context = unknown, UserProperties = unknown>(\n  definition: DefinedTelemetryTrace<Data, Context>,\n  context: Context | undefined,\n  sessionId: string,\n  emit: (event: TelemetryEvent) => void,\n  createLoggerFn: <UserProperties>(\n    sessionId: string,\n    emit: (event: TelemetryEvent) => void,\n  ) => TelemetryLogger<UserProperties>,\n): TelemetryTrace<UserProperties, Data> {\n  const traceId = createTraceId()\n  telemetryStoreDebug('Creating trace %s with traceId: %s', definition.name, traceId)\n\n  let isStarted = false\n  let isCompleted = false\n\n  const emitTraceEvent = (type: string, data?: Data | Error) => {\n    if (isCompleted && type !== 'trace.start') return\n\n    const baseEvent = {\n      context: context as Context,\n      createdAt: new Date().toISOString(),\n      name: definition.name,\n      sessionId,\n      traceId,\n      version: definition.version,\n    }\n\n    let traceEvent: TelemetryEvent\n\n    switch (type) {\n      case 'trace.complete': {\n        traceEvent = {\n          ...baseEvent,\n          type: 'trace.complete',\n          ...(data && {data}),\n        } as TelemetryEvent\n\n        break\n      }\n      case 'trace.error': {\n        traceEvent = {\n          ...baseEvent,\n          data,\n          type: 'trace.error',\n        } as TelemetryEvent\n\n        break\n      }\n      case 'trace.log': {\n        traceEvent = {\n          ...baseEvent,\n          data,\n          type: 'trace.log',\n        } as TelemetryEvent\n\n        break\n      }\n      case 'trace.start': {\n        traceEvent = {\n          ...baseEvent,\n          type: 'trace.start',\n        } as TelemetryEvent\n\n        break\n      }\n      default: {\n        return // Unknown type\n      }\n    }\n\n    emit(traceEvent)\n  }\n\n  const start = () => {\n    if (isStarted) {\n      telemetryStoreDebug('Trace %s already started', traceId)\n      return\n    }\n    telemetryStoreDebug('Starting trace %s', traceId)\n    isStarted = true\n    emitTraceEvent('trace.start')\n  }\n\n  const log = (data: Data) => {\n    telemetryStoreDebug('Logging data for trace %s', traceId)\n    if (!isStarted) start()\n    emitTraceEvent('trace.log', data)\n  }\n\n  const complete = () => {\n    if (isCompleted) {\n      telemetryStoreDebug('Trace %s already completed', traceId)\n      return\n    }\n    telemetryStoreDebug('Completing trace %s', traceId)\n    if (!isStarted) start()\n    emitTraceEvent('trace.complete')\n    isCompleted = true\n  }\n\n  const error = (err: Error) => {\n    if (isCompleted) {\n      telemetryStoreDebug('Trace %s already completed, ignoring error', traceId)\n      return\n    }\n    telemetryStoreDebug('Error in trace %s: %s', traceId, err.message)\n    if (!isStarted) start()\n    // Convert Error to serializable object\n    const errorData = {\n      message: err.message,\n      name: err.name,\n      stack: err.stack,\n    }\n    emitTraceEvent('trace.error', errorData)\n    isCompleted = true\n  }\n\n  const awaitPromise = <P extends Promise<unknown>>(promise: P, finalData?: Data): P => {\n    if (!isStarted) start()\n\n    return promise\n      .then((result) => {\n        if (finalData !== undefined) {\n          log(finalData)\n        }\n        complete()\n        return result\n      })\n      .catch((err) => {\n        error(err)\n        throw err\n      }) as P\n  }\n\n  const newContext = (name: string): TelemetryLogger<UserProperties> => {\n    const contextEmit = (event: TelemetryEvent) => {\n      // For trace events, we can add context, but for log events we need to be careful\n      if (event.type.startsWith('trace.')) {\n        const existingContext = (event as {context?: unknown}).context\n        emit({\n          ...event,\n          context: {\n            ...(typeof existingContext === 'object' && existingContext ? existingContext : {}),\n            contextName: name,\n          },\n        } as TelemetryEvent)\n      } else {\n        // For log events, we can't add context as it's not part of TelemetryLogEvent\n        // Just emit as-is\n        emit(event)\n      }\n    }\n\n    return createLoggerFn<UserProperties>(sessionId, contextEmit)\n  }\n\n  return {\n    await: awaitPromise,\n    complete,\n    error,\n    log,\n    newContext,\n    start,\n  }\n}\n"],"names":["createTraceId","telemetryStoreDebug","createTrace","definition","context","sessionId","emit","createLoggerFn","traceId","name","isStarted","isCompleted","emitTraceEvent","type","data","baseEvent","createdAt","Date","toISOString","version","traceEvent","start","log","complete","error","err","message","errorData","stack","awaitPromise","promise","finalData","then","result","undefined","catch","newContext","contextEmit","event","startsWith","existingContext","contextName","await"],"mappings":"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"}