{"version":3,"sources":["../src/importBatches.ts"],"sourcesContent":["import type {ImportReleaseAction, MultipleMutationResult, Transaction} from '@sanity/client'\nimport {partition} from 'lodash-es'\nimport pMap from 'p-map'\n\nimport type {ImportOptions, SanityApiError, SanityDocument} from './types.js'\nimport {progressStepper} from './util/progressStepper.js'\nimport {retryOnFailure} from './util/retryOnFailure.js'\nimport {suffixTag} from './util/suffixTag.js'\n\nconst DOCUMENT_IMPORT_CONCURRENCY = 6\n\nexport interface BatchImportResult {\n  count: number\n  importedIds: string[]\n}\n\nexport async function importBatches(\n  batches: SanityDocument[][],\n  options: ImportOptions,\n): Promise<BatchImportResult> {\n  const progress = progressStepper(options.onProgress, {\n    step: 'Importing documents',\n    total: batches.length,\n  })\n\n  const mapOptions = {concurrency: DOCUMENT_IMPORT_CONCURRENCY}\n  const batchResults = await pMap(\n    batches,\n    importBatch.bind(null, options, progress),\n    mapOptions,\n  )\n\n  return batchResults.reduce<BatchImportResult>(\n    (acc, result) => ({\n      count: acc.count + result.count,\n      importedIds: acc.importedIds.concat(result.importedIds),\n    }),\n    {count: 0, importedIds: []},\n  )\n}\n\nfunction importBatch(\n  options: ImportOptions,\n  progress: () => void,\n  batch: SanityDocument[],\n): Promise<BatchImportResult> {\n  const {client, operation, releasesOperation, tag} = options\n  const maxRetries = operation === 'create' ? 1 : 3\n\n  return retryOnFailure(\n    () => {\n      const [releaseDocs, docs] = partition(batch, (doc) => doc._id.startsWith('_.releases.'))\n\n      const docsTransaction =\n        docs.length > 0\n          ? docs\n              .reduce((trx: Transaction, doc) => {\n                if (operation === 'create') return trx.create(doc)\n                if (operation === 'createIfNotExists') return trx.createIfNotExists(doc)\n                if (operation === 'createOrReplace') return trx.createOrReplace(doc)\n                throw new Error(`Unknown operation: ${operation as string}`)\n              }, client.transaction())\n              .commit({visibility: 'async', tag: suffixTag(tag, 'doc.create')})\n              .then((res: MultipleMutationResult) => {\n                progress()\n                const importedIds = res.results\n                  .filter((r) => r.operation !== 'none')\n                  .map((r) => r.id)\n                return {count: res.results.length, importedIds}\n              })\n          : Promise.resolve({count: 0, importedIds: [] as string[]})\n\n      const releasesAction = releaseDocs.map((doc: SanityDocument) => {\n        const actionParams: ImportReleaseAction = {\n          actionType: 'sanity.action.release.import',\n          releaseId: doc.name as string,\n          attributes: doc,\n          ifExists: releasesOperation,\n        }\n        return client\n          .action(actionParams)\n          .then(() => ({count: 1, importedIds: [doc._id]}))\n          .catch((err: Error) => {\n            err.message = `Release import failed for ${doc._id}: ${err.message}`\n            throw err\n          })\n      })\n\n      return Promise.all([docsTransaction, ...releasesAction]).then((results) =>\n        results.reduce<BatchImportResult>(\n          (acc, result) => ({\n            count: acc.count + result.count,\n            importedIds: acc.importedIds.concat(result.importedIds),\n          }),\n          {count: 0, importedIds: []},\n        ),\n      )\n    },\n    {maxTries: maxRetries, isRetriable},\n  )\n}\n\nfunction isRetriable(err: SanityApiError): boolean {\n  return !err.response || err.response.statusCode !== 409\n}\n"],"names":["partition","pMap","progressStepper","retryOnFailure","suffixTag","DOCUMENT_IMPORT_CONCURRENCY","importBatches","batches","options","progress","onProgress","step","total","length","mapOptions","concurrency","batchResults","importBatch","bind","reduce","acc","result","count","importedIds","concat","batch","client","operation","releasesOperation","tag","maxRetries","releaseDocs","docs","doc","_id","startsWith","docsTransaction","trx","create","createIfNotExists","createOrReplace","Error","transaction","commit","visibility","then","res","results","filter","r","map","id","Promise","resolve","releasesAction","actionParams","actionType","releaseId","name","attributes","ifExists","action","catch","err","message","all","maxTries","isRetriable","response","statusCode"],"mappings":"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"}