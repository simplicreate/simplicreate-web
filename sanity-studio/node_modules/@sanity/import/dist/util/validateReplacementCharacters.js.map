{"version":3,"sources":["../../src/util/validateReplacementCharacters.ts"],"sourcesContent":["const REPLACEMENT_CHAR = '\\uFFFD'\n\nexport class ReplacementCharError extends Error {\n  constructor(message: string) {\n    super(message)\n    this.name = 'ReplacementCharError'\n  }\n}\n\n/**\n * Check if a string contains a Unicode replacement character (U+FFFD).\n * Returns the index of the first occurrence, or null if not found.\n */\nexport function checkStringForReplacementChar(str: string): number | null {\n  const index = str.indexOf(REPLACEMENT_CHAR)\n  return index === -1 ? null : index\n}\n\n/**\n * Recursively search an object for strings containing U+FFFD.\n * Returns the path to the first occurrence, or null if not found.\n */\nexport function findReplacementCharInObject(obj: unknown, currentPath: string = ''): string | null {\n  if (obj === null || obj === undefined) {\n    return null\n  }\n\n  if (typeof obj === 'string') {\n    const index = checkStringForReplacementChar(obj)\n    if (index === null) {\n      return null\n    }\n    return currentPath\n  }\n\n  if (Array.isArray(obj)) {\n    for (let i = 0; i < obj.length; i++) {\n      const result = findReplacementCharInObject(obj[i], `${currentPath}[${i}]`)\n      if (result !== null) {\n        return result\n      }\n    }\n    return null\n  }\n\n  if (typeof obj === 'object') {\n    for (const key of Object.keys(obj)) {\n      // Check the key itself for replacement characters\n      if (checkStringForReplacementChar(key) !== null) {\n        const keyPath = currentPath ? `${currentPath}[\"${key}\"]` : `[\"${key}\"]`\n        return keyPath\n      }\n\n      // Build the path for this key\n      const needsBracketNotation = !/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)\n      let keyPath: string\n      if (!currentPath) {\n        keyPath = key\n      } else if (needsBracketNotation) {\n        keyPath = `${currentPath}[\"${key}\"]`\n      } else {\n        keyPath = `${currentPath}.${key}`\n      }\n\n      const result = findReplacementCharInObject((obj as Record<string, unknown>)[key], keyPath)\n      if (result !== null) {\n        return result\n      }\n    }\n  }\n\n  return null\n}\n\n/**\n * Validate that a raw NDJSON line doesn't contain U+FFFD.\n * Returns an error message if found, or null if clean.\n */\nexport function validateLineForReplacementChar(line: string, lineNumber: number): string | null {\n  const index = checkStringForReplacementChar(line)\n  if (index !== null) {\n    return `Unicode replacement character (U+FFFD) found on line ${lineNumber}. This usually indicates encoding issues in the source data.`\n  }\n  return null\n}\n\n/**\n * Validate that an assetMap doesn't contain U+FFFD in any string values.\n * Throws an error if found.\n */\nexport function validateAssetMapForReplacementChars(assetMap: Record<string, unknown>): void {\n  // Check keys first\n  for (const key of Object.keys(assetMap)) {\n    if (checkStringForReplacementChar(key) !== null) {\n      throw new ReplacementCharError(\n        `Unicode replacement character (U+FFFD) found at assetMap[\"${key}\"] (in key). This usually indicates encoding issues in the source data.`,\n      )\n    }\n  }\n\n  // Check values\n  for (const [key, value] of Object.entries(assetMap)) {\n    const path = findReplacementCharInObject(value, '')\n    if (path !== null) {\n      let fullPath: string\n      if (!path) {\n        fullPath = `assetMap[\"${key}\"]`\n      } else if (path.startsWith('[')) {\n        fullPath = `assetMap[\"${key}\"]${path}`\n      } else {\n        fullPath = `assetMap[\"${key}\"].${path}`\n      }\n      throw new ReplacementCharError(\n        `Unicode replacement character (U+FFFD) found at ${fullPath}. This usually indicates encoding issues in the source data.`,\n      )\n    }\n  }\n}\n"],"names":["REPLACEMENT_CHAR","ReplacementCharError","Error","message","name","checkStringForReplacementChar","str","index","indexOf","findReplacementCharInObject","obj","currentPath","undefined","Array","isArray","i","length","result","key","Object","keys","keyPath","needsBracketNotation","test","validateLineForReplacementChar","line","lineNumber","validateAssetMapForReplacementChars","assetMap","value","entries","path","fullPath","startsWith"],"mappings":"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"}