{"version":3,"sources":["../../src/util/getJsonStreamer.ts"],"sourcesContent":["import split from 'split2'\n\nimport {validateDocument} from '../documentHasErrors.js'\nimport type {SanityDocument} from '../types.js'\nimport {\n  ReplacementCharError,\n  validateLineForReplacementChar,\n} from './validateReplacementCharacters.js'\n\nexport interface JsonStreamerOptions {\n  allowReplacementCharacters?: boolean | undefined\n}\n\nexport function getJsonStreamer(options: JsonStreamerOptions = {}): NodeJS.ReadWriteStream {\n  let lineNumber = 0\n  const {allowReplacementCharacters} = options\n\n  const getErrorMessage = (err: Error): string => {\n    const suffix =\n      lineNumber === 1 ? '\\n\\nMake sure this is valid ndjson (one JSON-document *per line*)' : ''\n\n    return `Failed to parse line #${lineNumber}: ${err.message}${suffix}`\n  }\n\n  return split(parseRow)\n\n  function parseRow(this: NodeJS.ReadWriteStream, row: string) {\n    lineNumber++\n\n    if (!row) {\n      return undefined\n    }\n\n    try {\n      // Check for replacement characters before parsing JSON\n      if (allowReplacementCharacters !== true) {\n        const replacementError = validateLineForReplacementChar(row, lineNumber)\n        if (replacementError) {\n          throw new ReplacementCharError(replacementError)\n        }\n      }\n\n      const doc = JSON.parse(row) as SanityDocument\n      const error = validateDocument(doc)\n      if (error) {\n        throw new Error(error)\n      }\n\n      return doc\n    } catch (err) {\n      if (err instanceof ReplacementCharError) {\n        this.emit('error', err)\n      } else if (err instanceof Error) {\n        this.emit('error', new Error(getErrorMessage(err)))\n      } else {\n        this.emit(\n          'error',\n          new Error(`Unknown error occurred at line #${lineNumber}: ${String(err)}`),\n        )\n      }\n    }\n\n    return undefined\n  }\n}\n"],"names":["split","validateDocument","ReplacementCharError","validateLineForReplacementChar","getJsonStreamer","options","lineNumber","allowReplacementCharacters","getErrorMessage","err","suffix","message","parseRow","row","undefined","replacementError","doc","JSON","parse","error","Error","emit","String"],"mappings":"AAAA,OAAOA,WAAW,SAAQ;AAE1B,SAAQC,gBAAgB,QAAO,0BAAyB;AAExD,SACEC,oBAAoB,EACpBC,8BAA8B,QACzB,qCAAoC;AAM3C,OAAO,SAASC,gBAAgBC,UAA+B,CAAC,CAAC;IAC/D,IAAIC,aAAa;IACjB,MAAM,EAACC,0BAA0B,EAAC,GAAGF;IAErC,MAAMG,kBAAkB,CAACC;QACvB,MAAMC,SACJJ,eAAe,IAAI,sEAAsE;QAE3F,OAAO,CAAC,sBAAsB,EAAEA,WAAW,EAAE,EAAEG,IAAIE,OAAO,GAAGD,QAAQ;IACvE;IAEA,OAAOV,MAAMY;IAEb,SAASA,SAAuCC,GAAW;QACzDP;QAEA,IAAI,CAACO,KAAK;YACR,OAAOC;QACT;QAEA,IAAI;YACF,uDAAuD;YACvD,IAAIP,+BAA+B,MAAM;gBACvC,MAAMQ,mBAAmBZ,+BAA+BU,KAAKP;gBAC7D,IAAIS,kBAAkB;oBACpB,MAAM,IAAIb,qBAAqBa;gBACjC;YACF;YAEA,MAAMC,MAAMC,KAAKC,KAAK,CAACL;YACvB,MAAMM,QAAQlB,iBAAiBe;YAC/B,IAAIG,OAAO;gBACT,MAAM,IAAIC,MAAMD;YAClB;YAEA,OAAOH;QACT,EAAE,OAAOP,KAAK;YACZ,IAAIA,eAAeP,sBAAsB;gBACvC,IAAI,CAACmB,IAAI,CAAC,SAASZ;YACrB,OAAO,IAAIA,eAAeW,OAAO;gBAC/B,IAAI,CAACC,IAAI,CAAC,SAAS,IAAID,MAAMZ,gBAAgBC;YAC/C,OAAO;gBACL,IAAI,CAACY,IAAI,CACP,SACA,IAAID,MAAM,CAAC,gCAAgC,EAAEd,WAAW,EAAE,EAAEgB,OAAOb,MAAM;YAE7E;QACF;QAEA,OAAOK;IACT;AACF"}