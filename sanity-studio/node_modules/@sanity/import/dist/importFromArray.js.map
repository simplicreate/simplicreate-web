{"version":3,"sources":["../src/importFromArray.ts"],"sourcesContent":["import createDebug from 'debug'\nimport {flatten} from 'lodash-es'\n\nimport {absolutifyPaths, getAssetRefs, unsetAssetRefs} from './assetRefs.js'\nimport {assignArrayKeys} from './assignArrayKeys.js'\nimport {assignDocumentId} from './assignDocumentId.js'\nimport {batchDocuments} from './batchDocuments.js'\nimport {documentHasError} from './documentHasErrors.js'\nimport {importBatches} from './importBatches.js'\nimport type {StrongRefsTask} from './references.js'\nimport {\n  cleanupReferences,\n  getStrongRefs,\n  strengthenReferences,\n  weakenStrongRefs,\n} from './references.js'\nimport type {ImportOptions, ImportResult, SanityDocument} from './types.js'\nimport {uploadAssets} from './uploadAssets.js'\nimport {ensureUniqueIds} from './util/ensureUniqueIds.js'\nimport {validateAssetMapForReplacementChars} from './util/validateReplacementCharacters.js'\nimport {validateAssetDocuments} from './validateAssetDocuments.js'\nimport {validateCdrDatasets} from './validateCdrDatasets.js'\n\nconst debug = createDebug('sanity:import:array')\n\nasync function importDocuments(\n  documents: SanityDocument[],\n  options: ImportOptions,\n): Promise<ImportResult> {\n  options.onProgress({step: 'Reading/validating data file'})\n  documents.forEach(documentHasError)\n\n  // Validate assetMap for replacement characters\n  if (options.assetMap && options.allowReplacementCharacters !== true) {\n    validateAssetMapForReplacementChars(options.assetMap)\n  }\n\n  // Validate that there are no duplicate IDs in the documents\n  ensureUniqueIds(documents)\n\n  // Ensure that any cross-dataset references has datasets to point to\n  if (!options.skipCrossDatasetReferences) {\n    await validateCdrDatasets(documents, options)\n  }\n\n  let filteredDocuments = documents\n  // Always filter out system documents unless explicitly allowed.\n  // Release system documents are an exception to this flag.\n  if (options.allowSystemDocuments !== true) {\n    filteredDocuments = documents.filter(\n      (doc) => doc._id?.startsWith('_.releases.') || !doc._id?.startsWith('_.'),\n    )\n  }\n\n  // Replace relative asset paths if one is defined\n  // (file://./images/foo-bar.png -> file:///abs/olute/images/foo-bar.png)\n  const absPathed = filteredDocuments.map((doc) => absolutifyPaths(doc, options.assetsBase))\n\n  // Assign document IDs for document that do not have one. This is necessary\n  // for us to strengthen references and import assets properly.\n  const ided = absPathed.map((doc) => assignDocumentId(doc))\n\n  // User might not have applied `_key` on array elements which are objects;\n  // if this is the case, generate random keys to help realtime engine\n  const keyed = ided.map((doc) => assignArrayKeys(doc))\n\n  // Sanity prefers to have a `_type` on every object. Make sure references\n  // has `_type` set to `reference`, and that there are no `_projectId` keys\n  const docs = keyed.map((doc) => cleanupReferences(doc, options))\n\n  // Find references that will need strengthening when import is done\n  const strongRefs = docs.map(getStrongRefs).filter((ref): ref is StrongRefsTask => ref !== null)\n\n  // Extract asset references from the documents\n  const assetRefs = flatten(docs.map(getAssetRefs).filter((ref) => ref.length))\n\n  // Remove asset references from the documents\n  const assetless = docs.map(unsetAssetRefs)\n\n  // Make strong references weak so they can be imported in any order\n  const weakened = assetless.map(weakenStrongRefs)\n\n  // Create batches of documents to import. Try to keep batches below a certain\n  // byte-size (since document may vary greatly in size depending on type etc)\n  const batches = batchDocuments(weakened)\n\n  // Ensure that we don't reference missing assets, or assets in different datasets\n  debug('Validating asset documents')\n  await validateAssetDocuments(docs, options)\n\n  // Trigger actual import process\n  debug('Starting import of documents')\n  const docsImported = await importBatches(batches, options)\n\n  // Documents are imported, now proceed with post-import operations\n  debug('Uploading assets')\n  const {failures: assetWarnings} = await uploadAssets(assetRefs, options)\n\n  // Strengthen references\n  debug('Strengthening references')\n  await strengthenReferences(strongRefs, options)\n\n  // Return number of documents imported\n  return {\n    numDocs: docsImported,\n    warnings: assetWarnings.map((warning) => ({message: `Failed to upload asset: ${warning.url}`})),\n  }\n}\n\nexport {importDocuments}\n"],"names":["createDebug","flatten","absolutifyPaths","getAssetRefs","unsetAssetRefs","assignArrayKeys","assignDocumentId","batchDocuments","documentHasError","importBatches","cleanupReferences","getStrongRefs","strengthenReferences","weakenStrongRefs","uploadAssets","ensureUniqueIds","validateAssetMapForReplacementChars","validateAssetDocuments","validateCdrDatasets","debug","importDocuments","documents","options","onProgress","step","forEach","assetMap","allowReplacementCharacters","skipCrossDatasetReferences","filteredDocuments","allowSystemDocuments","filter","doc","_id","startsWith","absPathed","map","assetsBase","ided","keyed","docs","strongRefs","ref","assetRefs","length","assetless","weakened","batches","docsImported","failures","assetWarnings","numDocs","warnings","warning","message","url"],"mappings":"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"}