{"version":3,"file":"index.js","sources":["../src/looks-like-url.ts","../src/plugin.paste-link.tsx"],"sourcesContent":["export function looksLikeUrl(text: string) {\n  try {\n    const url = new URL(text)\n    return sensibleProtocols.includes(url.protocol)\n  } catch {\n    return false\n  }\n}\n\nconst sensibleProtocols = ['http:', 'https:', 'mailto:', 'tel:']\n","import type {EditorContext} from '@portabletext/editor'\nimport {useEditor} from '@portabletext/editor'\nimport {\n  defineBehavior,\n  raise,\n  type BehaviorGuard,\n  type NativeBehaviorEvent,\n} from '@portabletext/editor/behaviors'\nimport * as selectors from '@portabletext/editor/selectors'\nimport {useEffect} from 'react'\nimport {looksLikeUrl} from './looks-like-url'\n\n/**\n * Guard function that controls when the paste link behavior runs.\n * Return `false` to skip the behavior and fall through to default paste handling.\n * @public\n */\nexport type PasteLinkGuard = BehaviorGuard<\n  Extract<NativeBehaviorEvent, {type: 'clipboard.paste'}>,\n  true\n>\n\n/**\n * Context provided to link matchers.\n * @public\n */\nexport type LinkMatcherContext = Pick<EditorContext, 'schema' | 'keyGenerator'>\n\n/**\n * Value provided to link matchers.\n * @public\n */\nexport type LinkMatcherValue = {href: string}\n\n/**\n * Object returned by link matchers.\n * @public\n */\nexport type LinkMatcherResult = {\n  _type: string\n  _key?: string\n  [other: string]: unknown\n}\n\n/**\n * Function that converts a pasted URL into a link annotation.\n * Return `undefined` to skip handling.\n * @public\n */\nexport type LinkMatcher = (params: {\n  context: LinkMatcherContext\n  value: LinkMatcherValue\n}) => LinkMatcherResult | undefined\n\n/**\n * @public\n */\nexport type PasteLinkPluginProps = {\n  guard?: PasteLinkGuard\n  link?: LinkMatcher\n}\n\nconst defaultLinkMatcher: LinkMatcher = ({context, value}) => {\n  const schemaType = context.schema.annotations.find(\n    (annotation) => annotation.name === 'link',\n  )\n  const hrefField = schemaType?.fields.find(\n    (field) => field.name === 'href' && field.type === 'string',\n  )\n\n  if (!schemaType || !hrefField) {\n    return undefined\n  }\n\n  return {\n    _type: schemaType.name,\n    [hrefField.name]: value.href,\n  }\n}\n\n/**\n * Plugin that handles pasting URLs in the editor.\n *\n * When text is selected and a URL is pasted, adds a link annotation to the selection.\n * When the caret is collapsed (no selection) and a URL is pasted, inserts the URL as text with a link annotation.\n *\n * @public\n */\nexport function PasteLinkPlugin({\n  guard,\n  link = defaultLinkMatcher,\n}: PasteLinkPluginProps) {\n  const editor = useEditor()\n\n  useEffect(() => {\n    const behaviors = createPasteLinkBehaviors({guard, link})\n    const unregisterBehaviors = behaviors.map((behavior) =>\n      editor.registerBehavior({behavior}),\n    )\n\n    return () => {\n      for (const unregisterBehavior of unregisterBehaviors) {\n        unregisterBehavior()\n      }\n    }\n  }, [editor, guard, link])\n\n  return null\n}\n\nfunction createPasteLinkBehaviors(\n  config: Required<Pick<PasteLinkPluginProps, 'link'>> &\n    Pick<PasteLinkPluginProps, 'guard'>,\n) {\n  /**\n   * When text is selected and a URL is pasted, add a link annotation to the\n   * selection. If the selection already has a link annotation, the core\n   * `preventOverlappingAnnotations` behavior will remove it first.\n   */\n  const pasteLinkOnSelection = defineBehavior({\n    on: 'clipboard.paste',\n    guard: (guardParams) => {\n      if (config.guard && config.guard(guardParams) === false) {\n        return false\n      }\n\n      const {snapshot, event} = guardParams\n      const selectionCollapsed = selectors.isSelectionCollapsed(snapshot)\n\n      if (selectionCollapsed) {\n        return false\n      }\n\n      const text = event.originEvent.dataTransfer.getData('text/plain')\n      const href = looksLikeUrl(text) ? text : undefined\n\n      if (!href) {\n        return false\n      }\n\n      const result = config.link({\n        context: {\n          schema: snapshot.context.schema,\n          keyGenerator: snapshot.context.keyGenerator,\n        },\n        value: {href},\n      })\n\n      if (!result) {\n        return false\n      }\n\n      const {_type, _key, ...value} = result\n\n      return {annotation: {name: _type, _key, value}}\n    },\n    actions: [\n      (_, {annotation}) => [\n        raise({\n          type: 'annotation.add',\n          annotation,\n        }),\n      ],\n    ],\n  })\n\n  /**\n   * When the caret is collapsed (no selection) and a URL is pasted, insert the\n   * URL as text with a link annotation. Existing decorators (bold, italic,\n   * etc.) are preserved.\n   */\n  const pasteLinkAtCaret = defineBehavior({\n    on: 'clipboard.paste',\n    guard: (guardParams) => {\n      if (config.guard && config.guard(guardParams) === false) {\n        return false\n      }\n\n      const {snapshot, event} = guardParams\n      const focusTextBlock = selectors.getFocusTextBlock(snapshot)\n      const selectionCollapsed = selectors.isSelectionCollapsed(snapshot)\n\n      if (!focusTextBlock || !selectionCollapsed) {\n        return false\n      }\n\n      const text = event.originEvent.dataTransfer.getData('text/plain')\n      const href = looksLikeUrl(text) ? text : undefined\n\n      if (!href) {\n        return false\n      }\n\n      const result = config.link({\n        context: {\n          schema: snapshot.context.schema,\n          keyGenerator: snapshot.context.keyGenerator,\n        },\n        value: {href},\n      })\n\n      if (!result) {\n        return false\n      }\n\n      const {_type, _key, ...value} = result\n\n      const markState = selectors.getMarkState(snapshot)\n      const decoratorNames = snapshot.context.schema.decorators.map(\n        (decorator) => decorator.name,\n      )\n      const activeDecorators = (markState?.marks ?? []).filter((mark) =>\n        decoratorNames.includes(mark),\n      )\n\n      const markDefKey = _key ?? snapshot.context.keyGenerator()\n      const markDef = {\n        _type,\n        _key: markDefKey,\n        ...value,\n      }\n\n      return {\n        focusTextBlock,\n        markDef,\n        markDefKey,\n        href,\n        activeDecorators,\n      }\n    },\n    actions: [\n      (\n        {snapshot},\n        {focusTextBlock, markDef, markDefKey, href, activeDecorators},\n      ) => [\n        raise({\n          type: 'block.set',\n          at: focusTextBlock.path,\n          props: {\n            markDefs: [...(focusTextBlock.node.markDefs ?? []), markDef],\n          },\n        }),\n        raise({\n          type: 'insert.child',\n          child: {\n            _type: snapshot.context.schema.span.name,\n            text: href,\n            marks: [...activeDecorators, markDefKey],\n          },\n        }),\n      ],\n    ],\n  })\n\n  return [pasteLinkOnSelection, pasteLinkAtCaret]\n}\n"],"names":["looksLikeUrl","text","url","URL","sensibleProtocols","includes","protocol","defaultLinkMatcher","context","value","schemaType","schema","annotations","find","annotation","name","hrefField","fields","field","type","_type","href","PasteLinkPlugin","t0","$","_c","guard","link","t1","undefined","editor","useEditor","t2","t3","unregisterBehaviors","createPasteLinkBehaviors","map","behavior","registerBehavior","unregisterBehavior","useEffect","config","pasteLinkOnSelection","defineBehavior","on","guardParams","snapshot","event","selectors","isSelectionCollapsed","originEvent","dataTransfer","getData","result","keyGenerator","_key","actions","_","raise","pasteLinkAtCaret","focusTextBlock","getFocusTextBlock","selectionCollapsed","markState","getMarkState","decoratorNames","decorators","decorator","activeDecorators","marks","filter","mark","markDefKey","markDef","at","path","props","markDefs","node","child","span"],"mappings":"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"}